<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Beyrouth Express ‚Äî Click & Collect | A Beyrouth, La D√©fense</title>
<meta name="description" content="Commandez en ligne chez A Beyrouth √† La D√©fense. Cuisine libanaise traditionnelle, retrait express sans faire la queue.">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßÜ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --green:#06C167;--green-dark:#05a559;
  --noir:#1A1A1A;--gris:#6B6B6B;--gris-light:#F2F2F2;
  --blanc:#FFFFFF;--bg:#F8F7F5;
  --gold:#C8A255;--bordeaux:#8B1A1A;
  --shadow:0 2px 12px rgba(0,0,0,.06);--shadow-lg:0 8px 24px rgba(0,0,0,.1);
  --radius:14px;--radius-sm:10px;
}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,sans-serif;color:var(--noir);background:var(--bg);line-height:1.5;overflow-x:hidden;padding-bottom:0}
button{cursor:pointer;font-family:inherit;border:none;outline:none}
img{max-width:100%;display:block}
a{color:inherit;text-decoration:none}

/* ========= HEADER ========= */
.header{
  background:var(--noir);color:#fff;padding:18px 24px;
}
.header-inner{max-width:1000px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.header-left h1{font-size:1.4rem;font-weight:800;letter-spacing:-.3px}
.header-left h1 span{color:var(--gold)}
.header-left p{font-size:.8rem;opacity:.6;margin-top:2px}
.header-right{display:flex;align-items:center;gap:8px}
.header-status{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.1);padding:6px 12px;border-radius:20px;font-size:.75rem;
}
.header-status .dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}
.header-status.closed .dot{background:#E74C3C}
.header-hours{font-size:.7rem;opacity:.5;margin-top:1px}

/* ========= TIMING BAR ========= */
.timing-bar{
  background:var(--blanc);border-bottom:1px solid var(--gris-light);
}
.timing-inner{
  max-width:1000px;margin:0 auto;padding:12px 24px;
  display:flex;align-items:center;gap:10px;
}
.timing-info{display:flex;align-items:center;gap:8px;margin-right:auto}
.timing-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}
.timing-dot.closed{background:#E74C3C}
.timing-text{font-size:.85rem;font-weight:600;color:var(--noir)}
.timing-text small{font-weight:400;color:var(--gris);font-size:.78rem}
.timing-pick{
  display:flex;align-items:center;gap:6px;
  padding:8px 16px;border-radius:20px;background:var(--gris-light);
  font-size:.82rem;font-weight:600;color:var(--noir);transition:all .2s;cursor:pointer;
}
.timing-pick:hover{background:#e0e0e0}

/* ========= TIME PICKER SHEET ========= */
.timepicker-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;
  opacity:0;pointer-events:none;transition:opacity .3s;
}
.timepicker-overlay.open{opacity:1;pointer-events:auto}
.timepicker-sheet{
  position:fixed;bottom:0;left:0;right:0;z-index:301;
  background:var(--blanc);border-radius:20px 20px 0 0;
  padding:24px 20px calc(24px + env(safe-area-inset-bottom,0px));
  transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
  max-height:70vh;overflow-y:auto;
}
.timepicker-sheet.open{transform:translateY(0)}
.timepicker-handle{width:40px;height:4px;border-radius:2px;background:#ddd;margin:0 auto 16px}
.timepicker-title{font-size:1.1rem;font-weight:800;text-align:center;margin-bottom:16px;letter-spacing:-.3px}
.timepicker-days{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
.timepicker-days::-webkit-scrollbar{display:none}
.timepicker-day{
  flex-shrink:0;padding:10px 18px;border-radius:12px;font-size:.85rem;font-weight:600;
  background:var(--gris-light);color:var(--noir);cursor:pointer;transition:all .2s;
  text-align:center;min-width:80px;
}
.timepicker-day.active{background:var(--bordeaux);color:#fff}
.timepicker-day small{display:block;font-size:.7rem;font-weight:400;opacity:.7;margin-top:2px}
.timepicker-slots{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.timepicker-slot{
  padding:12px 8px;border-radius:10px;font-size:.9rem;font-weight:600;
  background:var(--gris-light);color:var(--noir);cursor:pointer;
  text-align:center;transition:all .2s;
}
.timepicker-slot:hover{background:#e0e0e0;transform:scale(1.03)}
.timepicker-slot.active{background:var(--bordeaux);color:#fff}
.timepicker-slot.disabled{opacity:.3;pointer-events:none}
.timepicker-asap{
  width:100%;padding:14px;border-radius:12px;font-size:.95rem;font-weight:700;
  background:var(--green);color:#fff;margin-bottom:12px;transition:all .2s;
}
.timepicker-asap:hover{background:var(--green-dark)}
.timepicker-asap:disabled{opacity:.4;cursor:not-allowed}

/* ========= NAV CATEGORIES ========= */
.nav{
  position:sticky;top:0;z-index:100;background:var(--blanc);
  border-bottom:1px solid var(--gris-light);
}
.nav-inner{max-width:1000px;margin:0 auto;padding:0 24px;display:flex;align-items:center;gap:0;overflow-x:auto;scrollbar-width:none}
.nav-inner::-webkit-scrollbar{display:none}
.nav-cat{
  padding:14px 16px;font-size:.875rem;font-weight:500;
  white-space:nowrap;color:var(--gris);transition:all .2s;background:none;
  border-bottom:2px solid transparent;flex-shrink:0;
}
.nav-cat:hover{color:var(--noir)}
.nav-cat.active{color:var(--noir);font-weight:700;border-bottom-color:var(--bordeaux)}

/* ========= MENU ========= */
.menu-section{max-width:1000px;margin:0 auto;padding:16px 16px 100px}
.menu-cat-title{
  font-size:1.15rem;font-weight:800;margin:24px 0 12px;padding-top:4px;
  letter-spacing:-.3px;color:var(--noir);
  display:flex;align-items:center;gap:8px;
}
.menu-cat-title::after{
  content:'';flex:1;height:1px;background:var(--gris-light);
}
.menu-cat-title:first-child{margin-top:4px}

/* Grille de cartes */
.menu-grid{
  display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:8px;
}
.menu-card{
  position:relative;border-radius:var(--radius);overflow:hidden;
  background:var(--blanc);box-shadow:var(--shadow);cursor:pointer;
  transition:transform .25s cubic-bezier(.4,0,.2,1),box-shadow .25s;
  -webkit-tap-highlight-color:transparent;
}
.menu-card.reveal{opacity:0;transform:translateY(20px);transition:transform .5s cubic-bezier(.4,0,.2,1),box-shadow .25s,opacity .5s}
.menu-card.reveal.visible{opacity:1;transform:translateY(0)}
.menu-card:active{transform:scale(.97)}
@media(hover:hover){.menu-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-3px)}}

/* Image / emoji zone ‚Äî ratio 4:3 pour gagner de la place */
.menu-card-visual{
  width:100%;aspect-ratio:4/3;background:var(--gris-light);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;position:relative;
}
.menu-card-visual img{width:100%;height:100%;object-fit:cover}
.menu-card-visual .emoji-placeholder{font-size:2.8rem}

/* Infos en bas */
.menu-card-body{padding:8px 10px 10px}
.menu-card-name{font-weight:700;font-size:.88rem;line-height:1.25;margin-bottom:2px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;letter-spacing:-.2px}
.menu-card-desc{font-size:.72rem;color:var(--gris);line-height:1.3;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px}
.menu-card-bottom{display:flex;align-items:center;justify-content:space-between}
.menu-card-price{font-weight:800;font-size:.92rem;color:var(--bordeaux)}

/* Bouton + (min 44px pour touch) */
.menu-card-add{
  position:absolute;top:6px;right:6px;
  width:44px;height:44px;border-radius:50%;
  background:var(--blanc);box-shadow:0 2px 8px rgba(0,0,0,.2);
  font-size:1.4rem;display:flex;align-items:center;justify-content:center;
  transition:all .2s;font-weight:700;color:var(--noir);z-index:2;
  -webkit-tap-highlight-color:transparent;
}
@media(hover:hover){.menu-card-add:hover{background:var(--green);color:#fff;transform:scale(1.08)}}
.menu-card-add.in-cart{background:var(--green);color:#fff;font-size:.9rem;font-weight:800}
.menu-card-unavailable{opacity:.4;pointer-events:none}
.menu-card-unavailable .menu-card-add{display:none}

/* Stepper [-] qty [+] sur carte */
.menu-card-stepper{
  position:absolute;top:6px;right:6px;z-index:2;
  display:flex;align-items:center;
  background:var(--blanc);border-radius:22px;
  box-shadow:0 2px 8px rgba(0,0,0,.2);
}
.menu-card-stepper button{
  width:36px;height:36px;font-size:1.1rem;font-weight:700;
  background:none;display:flex;align-items:center;justify-content:center;
  transition:background .15s;-webkit-tap-highlight-color:transparent;
}
.menu-card-stepper button:first-child{color:#E74C3C}
.menu-card-stepper button:last-child{color:var(--green)}
.menu-card-stepper button:active{background:var(--gris-light);border-radius:50%}
.menu-card-stepper span{min-width:22px;text-align:center;font-weight:800;font-size:.85rem}

@media(min-width:640px){
  .menu-grid{grid-template-columns:repeat(3,1fr);gap:14px}
  .menu-card-visual{aspect-ratio:1}
}
@media(min-width:900px){
  .menu-grid{grid-template-columns:repeat(4,1fr)}
}

/* ========= BOTTOM CART BAR (style Uber Eats) ========= */
.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:150;
  padding:12px 24px calc(12px + env(safe-area-inset-bottom,0px));background:var(--blanc);
  border-top:1px solid var(--gris-light);
  transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);
}
.bottom-bar.show{transform:translateY(0)}
.bottom-bar-inner{max-width:1000px;margin:0 auto}
.bottom-bar-btn{
  width:100%;padding:16px;background:var(--bordeaux);color:#fff;
  border-radius:var(--radius-sm);font-size:1rem;font-weight:700;
  display:flex;align-items:center;justify-content:space-between;
  transition:all .25s;box-shadow:0 4px 16px rgba(139,26,26,.2);
}
.bottom-bar-btn:hover{background:#6B1414}
.bottom-bar-count{
  background:rgba(255,255,255,.2);padding:2px 10px;border-radius:20px;font-size:.85rem;
}
.bottom-bar-total{font-size:1rem}

/* ========= CART PANEL ========= */
.cart-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;
  opacity:0;pointer-events:none;transition:opacity .3s;
}
.cart-overlay.open{opacity:1;pointer-events:auto}
.cart-panel{
  position:fixed;top:0;right:0;bottom:0;width:min(440px,100vw);
  background:var(--blanc);z-index:201;
  transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;
}
.cart-panel.open{transform:translateX(0)}

.cart-header{
  padding:20px 20px 16px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--gris-light);flex-shrink:0;
}
.cart-header h3{font-size:1.15rem;font-weight:800;letter-spacing:-.3px}
.cart-close{background:var(--gris-light);width:44px;height:44px;border-radius:50%;font-size:1.4rem;display:flex;align-items:center;justify-content:center;transition:background .2s}
.cart-close:hover{background:#ddd}

.cart-body{flex:1;overflow-y:auto}
.cart-items{padding:12px 20px}
.cart-empty{text-align:center;padding:48px 20px;color:var(--gris);font-size:.9rem}
.cart-item{
  display:flex;gap:12px;padding:14px 0;border-bottom:1px solid var(--gris-light);
  align-items:center;
}
.cart-item:last-child{border-bottom:none}
.cart-item-emoji{font-size:1.6rem;width:40px;height:40px;
  background:var(--gris-light);border-radius:10px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cart-item-info{flex:1;min-width:0}
.cart-item-name{font-weight:700;font-size:.9rem;letter-spacing:-.2px}
.cart-item-price{font-size:.78rem;color:var(--gris);font-weight:500;margin-top:1px}
.cart-item-qty{display:flex;align-items:center;gap:8px;flex-shrink:0}
.cart-item-qty button{
  width:34px;height:34px;border-radius:50%;background:var(--gris-light);
  font-size:1.1rem;display:flex;align-items:center;justify-content:center;
  transition:all .2s;font-weight:600;
}
.cart-item-qty button:hover{background:#ddd;transform:scale(1.08)}
.cart-item-qty span{font-weight:800;min-width:22px;text-align:center;font-size:.9rem}

/* ========= CHECKOUT ========= */
.cart-footer{padding:16px 20px;background:var(--blanc)}
.cart-subtotal{
  display:flex;justify-content:space-between;margin-bottom:16px;
  padding:14px 16px;background:var(--gris-light);border-radius:var(--radius-sm);
  font-size:.9rem;color:var(--gris);
}
.cart-subtotal strong{color:var(--noir);font-size:1.15rem}
.cart-form{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.cart-form input,.cart-form select{
  padding:12px 14px;border:1.5px solid var(--gris-light);border-radius:var(--radius-sm);
  font-size:.9rem;font-family:inherit;background:var(--blanc);
  transition:border-color .2s;
}
.cart-form input:focus,.cart-form select:focus{border-color:var(--noir);outline:none}
.cart-form .form-row{display:flex;gap:8px}
.cart-form .form-row>*{flex:1}
.cart-checkout-btn{
  width:100%;padding:16px;background:var(--bordeaux);color:#fff;
  border-radius:var(--radius-sm);font-size:1rem;font-weight:700;
  transition:all .25s;letter-spacing:.3px;
  box-shadow:0 4px 16px rgba(139,26,26,.25);
}
.cart-checkout-btn:hover{background:#6B1414;transform:translateY(-1px);box-shadow:0 6px 20px rgba(139,26,26,.3)}
.cart-checkout-btn:disabled{opacity:.4;cursor:not-allowed}
.cart-pay-info{font-size:.75rem;color:var(--gris);text-align:center;margin-top:6px}
.cart-form-info{font-size:.8rem;color:var(--green);font-weight:500;margin:4px 0 0;line-height:1.4}
.cart-optin{display:flex;align-items:flex-start;gap:8px;font-size:.8rem;color:var(--gris);cursor:pointer;margin-top:2px}
.cart-optin input[type=checkbox]{width:18px;height:18px;accent-color:var(--green);flex-shrink:0;margin-top:1px}
.cart-form textarea{
  padding:12px 14px;border:1.5px solid var(--gris-light);border-radius:var(--radius-sm);
  font-size:.9rem;font-family:inherit;background:var(--blanc);resize:none;
  transition:border-color .2s;min-height:60px;
}
.cart-form textarea:focus{border-color:var(--noir);outline:none}

/* Suggestions upsell */
.cart-suggest{padding:0 20px 8px}
.cart-suggest-title{font-size:.8rem;font-weight:700;color:var(--gris);margin-bottom:8px}
.cart-suggest-list{display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:4px}
.cart-suggest-list::-webkit-scrollbar{display:none}
.cart-suggest-item{
  flex-shrink:0;display:flex;align-items:center;gap:8px;
  background:var(--gris-light);border-radius:var(--radius-sm);padding:8px 12px;
  cursor:pointer;transition:all .2s;font-size:.82rem;
}
.cart-suggest-item:hover{background:#e8e8e8;transform:translateY(-1px)}
.cart-suggest-item:active{background:#ddd;transform:scale(.97)}
.cart-suggest-item .suggest-emoji{font-size:1.2rem}
.cart-suggest-item .suggest-name{font-weight:600;white-space:nowrap}
.cart-suggest-item .suggest-price{color:var(--gris);font-size:.75rem;white-space:nowrap}
.cart-suggest-item .suggest-add{
  width:26px;height:26px;border-radius:50%;background:var(--green);color:#fff;
  font-size:.9rem;display:flex;align-items:center;justify-content:center;font-weight:700;
}

/* Upsell bubble toast */
.upsell-bubble{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(120px);
  z-index:160;background:var(--noir);color:#fff;
  padding:14px 20px;border-radius:16px;
  box-shadow:0 8px 32px rgba(0,0,0,.25);
  display:flex;align-items:center;gap:12px;
  max-width:min(400px,calc(100vw - 32px));
  transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .3s;
  opacity:0;pointer-events:none;
}
.upsell-bubble.show{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}
.upsell-bubble-emoji{font-size:1.6rem;flex-shrink:0}
.upsell-bubble-text{flex:1;font-size:.85rem;line-height:1.35}
.upsell-bubble-text strong{color:var(--green);font-weight:700}
.upsell-bubble-btn{
  background:var(--green);color:#fff;padding:8px 16px;border-radius:20px;
  font-size:.8rem;font-weight:700;white-space:nowrap;transition:all .2s;flex-shrink:0;
}
.upsell-bubble-btn:hover{background:var(--green-dark);transform:scale(1.05)}
.upsell-bubble-close{
  position:absolute;top:-8px;right:-8px;width:24px;height:24px;
  background:#555;color:#fff;border-radius:50%;font-size:.75rem;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:background .2s;
}
.upsell-bubble-close:hover{background:#777}

/* ========= CONFIRMATION MODAL ========= */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;
  display:none;align-items:center;justify-content:center;padding:24px;
}
.modal-overlay.open{display:flex}
.modal{
  background:var(--blanc);border-radius:var(--radius);padding:32px;
  max-width:400px;width:100%;text-align:center;
  animation:modalIn .3s ease-out;
}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:none}}
.modal-icon{font-size:3rem;margin-bottom:12px}
.modal h3{font-size:1.2rem;font-weight:800;margin-bottom:4px}
.modal-order-num{font-size:1.8rem;font-weight:800;color:var(--bordeaux);margin:8px 0}
.modal p{color:var(--gris);font-size:.9rem;margin-bottom:16px}
.modal-btn{
  display:inline-block;padding:12px 28px;background:var(--noir);
  color:#fff;border-radius:var(--radius-sm);font-weight:700;font-size:.9rem;transition:background .2s;
}
.modal-btn:hover{background:#333}

/* ========= FOOTER ========= */
.footer{background:var(--noir);color:#fff;padding:24px;text-align:center;font-size:.8rem;opacity:.6}

/* ========= RESPONSIVE ========= */
@media(max-width:640px){
  .header{padding:12px 16px}
  .header-inner{flex-direction:column;align-items:flex-start;gap:4px}
  .header-left h1{font-size:1.2rem}
  .timing-inner{flex-wrap:wrap;gap:6px;padding:8px 16px}
  .timing-tagline{width:100%;margin-right:0;font-size:.75rem}
  .timing-btn{padding:7px 16px;font-size:.8rem}
  .nav-inner{padding:0 12px}
  .nav-cat{padding:12px 14px;font-size:.82rem}
  .menu-section{padding:10px 10px calc(90px + env(safe-area-inset-bottom,0px))}
  .menu-cat-title{font-size:1.05rem;margin:16px 0 8px}
  .menu-grid{gap:8px}
  .menu-card-body{padding:6px 8px 8px}
  .menu-card-name{font-size:.82rem}
  .menu-card-desc{display:none}
  .menu-card-price{font-size:.88rem}
  .menu-card-add{width:38px;height:38px;font-size:1.2rem}
  .menu-card-stepper button{width:32px;height:32px;font-size:1rem}
  .bottom-bar{padding:10px 16px calc(10px + env(safe-area-inset-bottom,0px))}
  .cart-panel{width:100vw}
  .cart-footer{padding-bottom:calc(16px + env(safe-area-inset-bottom,0px))}
  .cart-form .form-row{flex-direction:column;gap:8px}
}

/* Petits √©crans (iPhone SE, 375px) */
@media(max-width:380px){
  .menu-grid{gap:6px}
  .menu-card-body{padding:5px 6px 7px}
  .menu-card-name{font-size:.78rem}
  .menu-card-price{font-size:.82rem}
  .timing-btn{padding:6px 12px;font-size:.75rem}
}
</style>
</head>
<body>

<!-- ===== HEADER COMPACT ===== -->
<header class="header">
  <div class="header-inner">
    <div class="header-left">
      <h1>A Beyrouth <span>Express</span></h1>
      <p>Click & Collect ‚Äî Commande, on pr√©pare, tu r√©cup√®res</p>
    </div>
    <div class="header-right">
      <div class="header-status" id="headerStatus"><span class="dot"></span> <span id="statusText">Ouvert</span></div>
      <div class="header-hours" id="headerHours"></div>
    </div>
  </div>
</header>

<!-- ===== TIMING BAR ===== -->
<div class="timing-bar">
  <div class="timing-inner">
    <div class="timing-info">
      <span class="timing-dot" id="timingDot"></span>
      <span class="timing-text" id="timingText">Ouvert <small>¬∑ Lun-Ven 11h‚Äì15h</small></span>
    </div>
    <div class="timing-pick" onclick="openTimePicker()">
      <span>üïê</span>
      <span id="timingPickLabel">D√®s que possible</span>
      <span style="font-size:.7rem;opacity:.5">‚ñº</span>
    </div>
  </div>
</div>

<!-- ===== TIME PICKER BOTTOM SHEET ===== -->
<div class="timepicker-overlay" id="tpOverlay" onclick="closeTimePicker()"></div>
<div class="timepicker-sheet" id="tpSheet">
  <div class="timepicker-handle"></div>
  <div class="timepicker-title">Quand voulez-vous manger ?</div>
  <button class="timepicker-asap" id="tpAsap" onclick="selectTime('asap')">
    ‚ö° D√®s que possible (~15 min)
  </button>
  <div class="timepicker-days" id="tpDays"></div>
  <div class="timepicker-slots" id="tpSlots"></div>
</div>

<!-- ===== NAV CATEGORIES ===== -->
<nav class="nav" id="nav">
  <div class="nav-inner" id="navCats"></div>
</nav>

<!-- ===== MENU ===== -->
<section class="menu-section" id="menu">
  <div id="menuContent"></div>
</section>

<!-- ===== BOTTOM CART BAR ===== -->
<div class="bottom-bar" id="bottomBar">
  <div class="bottom-bar-inner">
    <button class="bottom-bar-btn" onclick="toggleCart()">
      <span>Voir le panier <span class="bottom-bar-count" id="bottomCount">0</span></span>
      <span class="bottom-bar-total" id="bottomTotal">0,00 ‚Ç¨</span>
    </button>
  </div>
</div>

<!-- ===== CART PANEL ===== -->
<div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
<div class="cart-panel" id="cartPanel">
  <div class="cart-header">
    <h3>Votre commande</h3>
    <button class="cart-close" onclick="toggleCart()">&times;</button>
  </div>
  <div class="cart-body">
  <div class="cart-items" id="cartItems">
    <div class="cart-empty" id="cartEmpty">Votre panier est vide</div>
  </div>
  <div class="cart-suggest" id="cartSuggest" style="display:none">
    <div class="cart-suggest-title">Vous aimerez peut-√™tre aussi</div>
    <div class="cart-suggest-list" id="cartSuggestList"></div>
  </div>
  <div class="cart-footer" id="cartFooter" style="display:none">
    <div class="cart-subtotal">
      <span>Total</span>
      <strong id="cartTotal">0,00 ‚Ç¨</strong>
    </div>
    <div class="cart-form">
      <select id="pickupTime" style="display:none">
        <option value="asap">D√®s que possible (~15 min)</option>
      </select>
      <input type="text" id="clientName" placeholder="Pr√©nom" required>
      <div class="form-row">
        <input type="tel" id="clientPhone" placeholder="T√©l√©phone" required>
        <input type="email" id="clientEmail" placeholder="Email" required>
      </div>
      <textarea id="clientNote" placeholder="Note : allergies, sans oignon, etc."></textarea>
      <p class="cart-form-info">üì© On vous envoie un email quand c'est pr√™t !</p>
      <label class="cart-optin">
        <input type="checkbox" id="optinPromos">
        <span>Me tenir inform√© des offres et promotions</span>
      </label>
    </div>
    <button class="cart-checkout-btn" id="cartSubmit" onclick="submitOrder()">
      Passer la commande
    </button>
    <p class="cart-pay-info">Paiement en ligne s√©curis√© (CB, carte resto)</p>
  </div>
  </div><!-- /cart-body -->
</div>

<!-- ===== CONFIRMATION MODAL ===== -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-icon">&#10003;</div>
    <h3>Commande envoy√©e !</h3>
    <div class="modal-order-num" id="confirmOrderNum">BE-0001</div>
    <p id="confirmText">On pr√©pare votre commande.<br>Vous serez pr√©venu quand c'est pr√™t.</p>
    <a class="modal-btn" id="confirmTrackBtn" href="commande.html">Suivre ma commande</a>
  </div>
</div>

<!-- ===== UPSELL BUBBLE ===== -->
<div class="upsell-bubble" id="upsellBubble">
  <span class="upsell-bubble-emoji" id="upsellEmoji"></span>
  <div class="upsell-bubble-text" id="upsellText"></div>
  <button class="upsell-bubble-btn" id="upsellBtn" onclick="applyUpsell()">Ajouter</button>
  <div class="upsell-bubble-close" onclick="dismissUpsell()">&times;</div>
</div>

<!-- ===== FOOTER ===== -->
<footer class="footer">A Beyrouth ‚Äî La D√©fense ‚Äî beyrouth.express</footer>

<!-- ===== SUPABASE ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ===== CONFIG =====
const SUPABASE_URL = 'https://xbuftfwcyontgqbbrrjt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhidWZ0ZndjeW9udGdxYmJycmp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2Njg1NzksImV4cCI6MjA4NjI0NDU3OX0.ROkSccADlpLsWMgqyiX_xNaFdJNR8P4R-LJCnZV2Gzg';
let sb = null;
try { sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null; } catch(e) { console.error('Supabase init error:', e); }

// ===== STATE =====
let categories = [];
let menuItems = [];
let ingredients = [];
let cart = JSON.parse(localStorage.getItem('be_cart') || '[]');

// ===== DEMO DATA (menu r√©el A Beyrouth) =====
const DEMO_CATEGORIES = [
  {id:2, nom:'Formules', ordre:1, emoji:'üçΩÔ∏è'},
  {id:1, nom:'Sandwichs', ordre:2, emoji:'üåØ'},
  {id:3, nom:'Grillades', ordre:3, emoji:'üî•'},
  {id:4, nom:'Plateaux', ordre:4, emoji:'ü•ò'},
  {id:5, nom:'Entr√©es Froides', ordre:5, emoji:'üßÜ'},
  {id:13, nom:'Entr√©es Chaudes', ordre:6, emoji:'ü•ü'},
  {id:6, nom:'Desserts', ordre:7, emoji:'üçÆ'},
  {id:7, nom:'Boissons', ordre:8, emoji:'ü•§'},
];

const DEMO_ITEMS = [
  // === SANDWICHS (tous √† 6.90‚Ç¨) ===
  {id:1, categorie_id:1, nom:'Shawarma Poulet', description:'√âminc√© de poulet marin√©, crudit√©s, sauce maison', prix:6.90, emoji:'üåØ', image_url:'img/sandwich-shawarma.jpg', disponible:true},
  {id:2, categorie_id:1, nom:'Chich Taouk', description:'Brochette de blanc de poulet marin√©', prix:6.90, emoji:'üåØ', image_url:'img/sandwich-chich-taouk.jpg', disponible:true},
  {id:3, categorie_id:1, nom:'Shawarma Boeuf', description:'√âminc√© de boeuf marin√©, crudit√©s, sauce maison', prix:6.90, emoji:'üåØ', image_url:'img/sandwich-boeuf.jpg', disponible:true},
  {id:4, categorie_id:1, nom:'Falafel', description:'Boulette de f√®ves et pois chiches', prix:6.90, emoji:'üßÜ', image_url:'img/sandwich-falafel.jpg', disponible:true},
  {id:5, categorie_id:1, nom:'Veggie', description:'Chou fleur, aubergine, crudit√©s', prix:6.90, emoji:'ü•¨', image_url:'img/sandwich-veggie.jpg', disponible:true},
  {id:6, categorie_id:1, nom:'Foie de Volaille', description:'Marin√© au citron', prix:6.90, emoji:'üçó', image_url:'img/sandwich-foie-volaille.jpg', disponible:true},
  {id:7, categorie_id:1, nom:'Kafta', description:'Brochette de boeuf hach√©e persill√©e', prix:6.90, emoji:'üç¢', image_url:'img/sandwich-kafta.jpg', disponible:true},
  {id:8, categorie_id:1, nom:'Soujouk', description:'Saucisses de boeuf √©pic√©es', prix:6.90, emoji:'üå≠', image_url:'img/sandwich-soujouk.jpg', disponible:true},

  // === FORMULES ===
  {id:10, categorie_id:2, nom:'Formule 1', description:'Sandwich + 2 feuillet√©s + boisson', prix:10.90, emoji:'1Ô∏è‚É£', disponible:true},
  {id:11, categorie_id:2, nom:'Formule 2', description:'Sandwich + entr√©e froide + boisson', prix:11.90, emoji:'2Ô∏è‚É£', disponible:true},
  {id:12, categorie_id:2, nom:'Formule 3', description:'Sandwich + dessert + boisson', prix:11.90, emoji:'3Ô∏è‚É£', disponible:true},
  {id:13, categorie_id:2, nom:'Formule 4', description:'2 sandwiches au choix + boisson', prix:14.90, emoji:'4Ô∏è‚É£', disponible:true},
  {id:14, categorie_id:2, nom:'Formule Plat du Jour', description:'Plat du jour + boisson', prix:13.90, emoji:'üçΩÔ∏è', disponible:true},

  // === GRILLADES ===
  {id:20, categorie_id:3, nom:'Kafta M√©choui', description:'2 brochettes boeuf, riz, crudit√©s', prix:13.00, emoji:'üç¢', disponible:true},
  {id:21, categorie_id:3, nom:'Chich Taouk', description:'2 brochettes poulet, riz, crudit√©s', prix:13.00, emoji:'üçó', disponible:true},
  {id:22, categorie_id:3, nom:'Shawarma Poulet ou Boeuf', description:'√âminc√© marin√© grill√© √† la broche, riz, crudit√©s', prix:15.00, emoji:'üåØ', disponible:true},
  {id:24, categorie_id:3, nom:'Grillade Mixte', description:'Shawarma poulet, kafta, chich taouk, riz, crudit√©s', prix:16.00, emoji:'üî•', disponible:true},

  // === PLATEAUX ===
  {id:30, categorie_id:4, nom:'Beyrouth Poulet', description:'Houmous, moutabal, taboul√©, shawarma poulet, riz', prix:14.00, emoji:'ü•ò', disponible:true},
  {id:31, categorie_id:4, nom:'Beyrouth Boeuf', description:'Houmous, moutabal, taboul√©, shawarma boeuf, riz', prix:15.00, emoji:'ü•ò', disponible:true},
  {id:32, categorie_id:4, nom:'V√©g√©tarienne', description:'Houmous, moutabal, moussaka, crudit√©s, 3 feuillet√©s v√©g√©tariens', prix:14.00, emoji:'ü•¨', disponible:true},
  {id:33, categorie_id:4, nom:'Falafel', description:'Houmous, moutabal, taboul√©, crudit√©s, 3 falafels', prix:14.00, emoji:'üßÜ', disponible:true},
  {id:34, categorie_id:4, nom:'Liban', description:'Houmous, moutabal, chich taouk, riz, crudit√©s, 2 feuillet√©s v√©g√©tariens', prix:16.00, emoji:'üá±üáß', disponible:true},
  {id:35, categorie_id:4, nom:'Byblos', description:'Houmous, moutabal, taboul√©, 3 feuillet√©s v√©g√©tariens, kafta, chich taouk, shawarma poulet, riz', prix:18.00, emoji:'üëë', disponible:true},

  // === ENTR√âES FROIDES ===
  {id:40, categorie_id:5, nom:'Houmous', description:'Pur√©e de pois chiches au tahini, parfum√©e au citron et √† l\'huile d\'olive', prix:6.00, emoji:'ü´ò', image_url:'img/houmous.jpg', disponible:true},
  {id:41, categorie_id:5, nom:'Moutabal', description:'Caviar d\'aubergines r√¥ties √† la cr√®me de s√©same, jus de citron', prix:6.00, emoji:'üçÜ', image_url:'img/moutabal.jpg', disponible:true},
  {id:42, categorie_id:5, nom:'Taboul√©', description:'Salade de persil, tomates, oignons, bl√© concass√©, huile d\'olive, citron', prix:6.00, emoji:'ü•ó', image_url:'img/taboule.jpg', disponible:true},
  {id:43, categorie_id:5, nom:'Salade du Moine', description:'Aubergines grill√©es, tomates, persil, poivrons, huile d\'olive, jus de citron', prix:6.00, emoji:'ü•ó', image_url:'img/salade-moine.jpg', disponible:true},
  {id:44, categorie_id:5, nom:'Moussaka', description:'Aubergines au four, cuisin√©es √† la sauce tomate, pois chiches', prix:7.50, emoji:'üç≤', image_url:'img/plat-jour.jpg', disponible:true},
  {id:45, categorie_id:5, nom:'Feuilles de Vignes', description:'Farcies de riz, huile d\'olive, citron', prix:6.00, emoji:'üåø', image_url:'img/feuilles-vigne.jpg', disponible:true},

  // === ENTR√âES CHAUDES ===
  {id:70, categorie_id:13, nom:'Falafel (pi√®ce)', description:'F√®ves et pois chiches √† la coriandre', prix:1.50, emoji:'üßÜ', image_url:'img/falafel.jpg', disponible:true},
  {id:71, categorie_id:13, nom:'Fattayer', description:'Chaussons aux √©pinards acidul√©s', prix:1.50, emoji:'ü•ü', image_url:'img/fattayer.jpg', disponible:true},
  {id:72, categorie_id:13, nom:'Samboussek Fromage', description:'Fromage de feta', prix:1.50, emoji:'ü•ü', image_url:'img/sambousek-fromage.jpg', disponible:true},
  {id:73, categorie_id:13, nom:'Rikakat Fromage', description:'Fromage de feta', prix:2.00, emoji:'üßÄ', image_url:'img/rkakat.jpg', disponible:true},
  {id:74, categorie_id:13, nom:'Samboussek Viande', description:'Viande de boeuf hach√©', prix:1.50, emoji:'ü•ü', image_url:'img/sambousek-viande.jpg', disponible:true},
  {id:75, categorie_id:13, nom:'Kebb√©', description:'Boulette de bl√© concass√© farcies de viande hach√©e', prix:2.50, emoji:'üç°', image_url:'img/kebbe.jpg', disponible:true},

  // === DESSERTS ===
  {id:50, categorie_id:6, nom:'Mouhalabieh', description:'Flan fleur d\'oranger, pistaches (fait maison)', prix:4.00, emoji:'üçÆ', image_url:'img/mouhalabieh.jpg', disponible:true},
  {id:51, categorie_id:6, nom:'Namoura', description:'G√¢teau de semoule, sirop fleur d\'oranger', prix:4.00, emoji:'üç∞', image_url:'img/namoura.jpg', disponible:true},
  {id:52, categorie_id:6, nom:'Baklawas', description:'Bo√Æte de 3 pi√®ces', prix:4.50, emoji:'üçØ', image_url:'img/baklawas.jpg', disponible:true},
  {id:53, categorie_id:6, nom:'Duo Sabl√©s', description:'2 sabl√©s : pistaches, amandes, noix ou dattes', prix:5.00, emoji:'üç™', image_url:'img/duo-sables.jpg', disponible:true},

  // === BOISSONS ===
  {id:60, categorie_id:7, nom:'Coca-Cola', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/coca.jpg', disponible:true},
  {id:61, categorie_id:7, nom:'Fanta', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/fanta.jpg', disponible:true},
  {id:62, categorie_id:7, nom:'Oasis Tropical', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/oasis.jpg', disponible:true},
  {id:63, categorie_id:7, nom:'Lipton P√™che', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/lipton.jpg', disponible:true},
  {id:64, categorie_id:7, nom:'7Up', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/7up.jpg', disponible:true},
  {id:65, categorie_id:7, nom:'Coca-Cola Zero', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/coca-zero.jpg', disponible:true},
  {id:66, categorie_id:7, nom:'Perrier', description:'Canette 33cl', prix:2.00, emoji:'ü´ß', image_url:'img/perrier.jpg', disponible:true},
  {id:67, categorie_id:7, nom:'Ayran', description:'Yaourt sal√©, rafra√Æchissant', prix:2.50, emoji:'ü•õ', disponible:true},
  {id:68, categorie_id:7, nom:'Eau Plate', description:'50cl', prix:2.00, emoji:'üíß', image_url:'img/eau.jpg', disponible:true},
];

// ===== HORAIRES =====
const BUSINESS_HOURS = [
  // [jour (0=dim), ouverture_h, ouverture_m, fermeture_h, fermeture_m]
  [1, 11, 0, 15, 0], // Lundi
  [2, 11, 0, 15, 0], // Mardi
  [3, 11, 0, 15, 0], // Mercredi
  [4, 11, 0, 15, 0], // Jeudi
  [5, 11, 0, 15, 0], // Vendredi
  // Samedi & Dimanche : ferm√©
];
const JOURS = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

function isOpenNow() {
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const slot = BUSINESS_HOURS.find(s => s[0] === day);
  if (!slot) return false;
  const nowMin = h * 60 + m;
  return nowMin >= slot[1] * 60 + slot[2] && nowMin < slot[3] * 60 + slot[4];
}

function getNextOpenSlot() {
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const nowMin = h * 60 + m;
  // Check today (not yet open?)
  const today = BUSINESS_HOURS.find(s => s[0] === day);
  if (today && nowMin < today[1] * 60 + today[2]) {
    return {jour: JOURS[day], h: today[1], m: today[2]};
  }
  // Check next days
  for (let i = 1; i <= 7; i++) {
    const d = (day + i) % 7;
    const slot = BUSINESS_HOURS.find(s => s[0] === d);
    if (slot) return {jour: JOURS[d], h: slot[1], m: slot[2]};
  }
  return null;
}

function updateOpenStatus() {
  const statusEl = document.getElementById('headerStatus');
  const textEl = document.getElementById('statusText');
  const hoursEl = document.getElementById('headerHours');
  const open = isOpenNow();
  if (open) {
    statusEl.classList.remove('closed');
    textEl.textContent = 'Ouvert';
    const now = new Date();
    const slot = BUSINESS_HOURS.find(s => s[0] === now.getDay());
    hoursEl.textContent = `Jusqu'√† ${slot[3]}h${slot[4] ? String(slot[4]).padStart(2,'0') : '00'}`;
  } else {
    statusEl.classList.add('closed');
    textEl.textContent = 'Ferm√©';
    const next = getNextOpenSlot();
    hoursEl.textContent = next ? `Ouvre ${next.jour} ${next.h}h${next.m ? String(next.m).padStart(2,'0') : '00'}` : '';
  }
  return open;
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', init);

async function init() {
  generateTimeSlots();
  const open = updateOpenStatus();
  setInterval(updateOpenStatus, 60000); // refresh chaque minute
  if (sb) {
    await loadFromSupabase();
    subscribeRealtime();
  } else {
    categories = DEMO_CATEGORIES;
    menuItems = DEMO_ITEMS;
  }
  renderMenu();
  renderNavCats();
  updateCartUI();
  setupScrollSpy();
  setupScrollReveal();
  updateTimingBar();
  loadClientInfo();
}

// ===== SUPABASE =====
async function loadFromSupabase() {
  try {
    const [catRes, itemRes, ingRes] = await Promise.all([
      sb.from('menu_categories').select('*').order('ordre'),
      sb.from('menu_items').select('*').eq('actif', true).order('id'),
      sb.from('ingredients').select('*'),
    ]);
    if (catRes.data && catRes.data.length && itemRes.data && itemRes.data.length) {
      categories = catRes.data;
      menuItems = itemRes.data;
      if (ingRes.data) ingredients = ingRes.data;
      applyIngredientAvailability();
    } else {
      throw new Error('Donn√©es incompl√®tes');
    }
  } catch (e) {
    console.error('Erreur chargement:', e);
    categories = DEMO_CATEGORIES;
    menuItems = DEMO_ITEMS;
  }
}

function applyIngredientAvailability() {
  const unavailable = new Set(ingredients.filter(i => !i.disponible).map(i => i.nom.toLowerCase()));
  menuItems.forEach(item => {
    if (item.ingredients && Array.isArray(item.ingredients)) {
      if (item.ingredients.some(ing => unavailable.has(ing.toLowerCase()))) item.disponible = false;
    }
  });
}

function subscribeRealtime() {
  sb.channel('menu-changes')
    .on('postgres_changes', {event:'*', schema:'public', table:'ingredients'}, () => loadFromSupabase().then(renderMenu))
    .on('postgres_changes', {event:'*', schema:'public', table:'menu_items'}, () => loadFromSupabase().then(renderMenu))
    .subscribe();
}

// ===== RENDER =====
function renderMenu() {
  const container = document.getElementById('menuContent');
  let html = '';
  categories.forEach(cat => {
    const items = menuItems.filter(i => i.categorie_id === cat.id);
    if (!items.length) return;
    html += `<h2 class="menu-cat-title" id="cat-${cat.id}">${cat.emoji || ''} ${cat.nom}</h2>`;
    html += '<div class="menu-grid">';
    items.forEach(item => {
      const qty = getCartQty(item.id);
      html += `
        <div class="menu-card ${!item.disponible ? 'menu-card-unavailable' : ''}" data-id="${item.id}" onclick="${item.disponible ? `addToCart(${item.id})` : ''}">
          <div class="menu-card-visual">
            ${item.image_url
              ? `<img src="${item.image_url}" alt="${item.nom}" loading="lazy">`
              : `<span class="emoji-placeholder">${item.emoji || 'üçΩÔ∏è'}</span>`
            }
          </div>
          ${qty > 0 ? `
          <div class="menu-card-stepper">
            <button onclick="event.stopPropagation();changeQty(${item.id},-1)">&minus;</button>
            <span>${qty}</span>
            <button onclick="event.stopPropagation();addToCart(${item.id})">+</button>
          </div>` : `
          <button class="menu-card-add"
                  onclick="event.stopPropagation();addToCart(${item.id})"
                  ${!item.disponible ? 'disabled' : ''}>+</button>`}
          <div class="menu-card-body">
            <div class="menu-card-name">${item.nom}</div>
            <div class="menu-card-desc">${item.description || ''}</div>
            <div class="menu-card-bottom">
              <span class="menu-card-price">${formatPrice(item.prix)}</span>
            </div>
          </div>
        </div>`;
    });
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderNavCats() {
  const nav = document.getElementById('navCats');
  nav.innerHTML = categories.map(cat =>
    `<button class="nav-cat" data-cat="${cat.id}" onclick="scrollToCat(${cat.id})">${cat.nom}</button>`
  ).join('');
}

// ===== CART =====
function getCartQty(id) { const c = cart.find(c => c.id === id); return c ? c.qty : 0; }

function addToCart(itemId) {
  const item = menuItems.find(i => i.id === itemId);
  if (!item || !item.disponible) return;
  const existing = cart.find(c => c.id === itemId);
  const isNew = !existing;
  if (existing) { existing.qty++; } else {
    cart.push({id: item.id, nom: item.nom, prix: item.prix, emoji: item.emoji || 'üçΩÔ∏è', qty: 1});
  }
  saveCart(); updateCartUI(); renderMenu();
  // Smart upsell bubble on first add
  if (isNew) showUpsellBubble(itemId);
}

function changeQty(itemId, delta) {
  const item = cart.find(c => c.id === itemId);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(c => c.id !== itemId);
  saveCart(); updateCartUI(); renderMenu();
}

function updateCartUI() {
  const total = cart.reduce((s, c) => s + c.prix * c.qty, 0);
  const count = cart.reduce((s, c) => s + c.qty, 0);

  // Bottom bar
  const bar = document.getElementById('bottomBar');
  bar.classList.toggle('show', count > 0);
  document.getElementById('bottomCount').textContent = count;
  document.getElementById('bottomTotal').textContent = formatPrice(total);

  // Cart panel
  const itemsEl = document.getElementById('cartItems');
  const emptyEl = document.getElementById('cartEmpty');
  const footerEl = document.getElementById('cartFooter');
  const totalEl = document.getElementById('cartTotal');
  const suggestEl = document.getElementById('cartSuggest');

  if (cart.length === 0) {
    emptyEl.style.display = '';
    footerEl.style.display = 'none';
    suggestEl.style.display = 'none';
    itemsEl.querySelectorAll('.cart-item').forEach(el => el.remove());
    return;
  }
  emptyEl.style.display = 'none';
  footerEl.style.display = '';
  totalEl.textContent = formatPrice(total);

  const existing = itemsEl.querySelectorAll('.cart-item');
  existing.forEach(el => el.remove());
  cart.forEach(c => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `
      <div class="cart-item-emoji">${c.emoji}</div>
      <div class="cart-item-info">
        <div class="cart-item-name">${c.nom}</div>
        <div class="cart-item-price">${formatPrice(c.prix)} chacun</div>
      </div>
      <div class="cart-item-qty">
        <button onclick="changeQty(${c.id},-1)">&minus;</button>
        <span>${c.qty}</span>
        <button onclick="changeQty(${c.id},1)">+</button>
      </div>`;
    itemsEl.appendChild(div);
  });

  // Suggestions upsell
  renderSuggestions();
}

function renderSuggestions() {
  const suggestEl = document.getElementById('cartSuggest');
  const listEl = document.getElementById('cartSuggestList');
  const cartIds = new Set(cart.map(c => c.id));
  const cartCatIds = new Set(cart.map(c => {
    const item = menuItems.find(i => i.id === c.id);
    return item ? item.categorie_id : 0;
  }));

  // Smart suggestions: prioritize what pairs with cart content
  let suggestions = [];

  // Has sandwich/grillade/plateau but no drink ‚Üí push drinks first
  if ((cartCatIds.has(1) || cartCatIds.has(3) || cartCatIds.has(4)) && !cartCatIds.has(7)) {
    suggestions.push(...menuItems.filter(i => i.categorie_id === 7 && i.disponible && !cartIds.has(i.id)).slice(0, 3));
  }
  // Has main course but no dessert ‚Üí push desserts
  if ((cartCatIds.has(1) || cartCatIds.has(2) || cartCatIds.has(3) || cartCatIds.has(4)) && !cartCatIds.has(6)) {
    suggestions.push(...menuItems.filter(i => i.categorie_id === 6 && i.disponible && !cartIds.has(i.id)).slice(0, 3));
  }
  // Has main but no entr√©e ‚Üí push entr√©es chaudes (small items, easy add)
  if ((cartCatIds.has(1) || cartCatIds.has(3)) && !cartCatIds.has(13)) {
    suggestions.push(...menuItems.filter(i => i.categorie_id === 13 && i.disponible && !cartIds.has(i.id)).slice(0, 2));
  }
  // Dedupe and limit
  suggestions = [...new Map(suggestions.map(s => [s.id, s])).values()].slice(0, 6);

  if (suggestions.length === 0 || cart.length === 0) {
    suggestEl.style.display = 'none';
    return;
  }

  // Dynamic title based on what's missing
  const titleEl = suggestEl.querySelector('.cart-suggest-title');
  if (!cartCatIds.has(7)) titleEl.textContent = 'Une boisson avec √ßa ?';
  else if (!cartCatIds.has(6)) titleEl.textContent = 'Une petite douceur pour finir ?';
  else titleEl.textContent = 'Vous aimerez peut-√™tre aussi';

  suggestEl.style.display = '';
  listEl.innerHTML = suggestions.map(s => `
    <div class="cart-suggest-item" onclick="addToCart(${s.id});updateCartUI();renderMenu()">
      <span class="suggest-emoji">${s.emoji || 'üçΩÔ∏è'}</span>
      <div>
        <div class="suggest-name">${s.nom}</div>
        <div class="suggest-price">${formatPrice(s.prix)}</div>
      </div>
      <span class="suggest-add">+</span>
    </div>
  `).join('');
}

// ===== SMART UPSELL BUBBLE =====
let upsellTimeout = null;
let pendingUpsell = null;

function getSmartUpsell(addedItem) {
  const item = menuItems.find(i => i.id === addedItem);
  if (!item) return null;
  const cartCatIds = new Set(cart.map(c => {
    const mi = menuItems.find(i => i.id === c.id);
    return mi ? mi.categorie_id : 0;
  }));

  // Sandwich seul ‚Üí pousse formule
  if (item.categorie_id === 1 && !cartCatIds.has(2)) {
    const formule1 = menuItems.find(i => i.id === 10 && i.disponible);
    if (formule1) {
      const savings = item.prix + 2.00 + 1.50 + 1.50 - formule1.prix; // sandwich + boisson + 2 feuillet√©s - formule
      return {
        emoji: 'üí°',
        text: `<strong>Formule 1 √† ${formatPrice(formule1.prix)}</strong> ‚Äî sandwich + 2 feuillet√©s + boisson. Vous √©conomisez !`,
        action: () => { cart = cart.filter(c => c.id !== addedItem); addToCart(formule1.id); },
        btn: 'Passer en formule'
      };
    }
  }

  // Formule ‚Üí pousse dessert
  if (item.categorie_id === 2 && !cartCatIds.has(6)) {
    const desserts = menuItems.filter(i => i.categorie_id === 6 && i.disponible);
    if (desserts.length) {
      const d = desserts[Math.floor(Math.random() * desserts.length)];
      return {
        emoji: 'üçÆ',
        text: `Finissez en douceur ! <strong>${d.nom}</strong> ‚Äî ${formatPrice(d.prix)}`,
        action: () => addToCart(d.id),
        btn: `+ ${formatPrice(d.prix)}`
      };
    }
  }

  // Grillade/Plateau sans boisson
  if ([3, 4].includes(item.categorie_id) && !cartCatIds.has(7)) {
    return {
      emoji: 'ü•§',
      text: 'Une <strong>boisson fra√Æche</strong> avec votre plat ? √Ä partir de <strong>2,00 ‚Ç¨</strong>',
      action: () => scrollToCat(7),
      btn: 'Voir les boissons'
    };
  }

  // Dessert seul ‚Üí pousse boisson (Ayran par ex)
  if (item.categorie_id === 6 && !cartCatIds.has(7)) {
    const ayran = menuItems.find(i => i.nom === 'Ayran' && i.disponible);
    if (ayran) {
      return {
        emoji: 'ü•õ',
        text: `Accompagnez avec un <strong>Ayran</strong> ‚Äî yaourt sal√© rafra√Æchissant ${formatPrice(ayran.prix)}`,
        action: () => addToCart(ayran.id),
        btn: `+ ${formatPrice(ayran.prix)}`
      };
    }
  }

  return null;
}

function showUpsellBubble(addedItemId) {
  const upsell = getSmartUpsell(addedItemId);
  if (!upsell) return;
  pendingUpsell = upsell;
  document.getElementById('upsellEmoji').textContent = upsell.emoji;
  document.getElementById('upsellText').innerHTML = upsell.text;
  document.getElementById('upsellBtn').textContent = upsell.btn;
  const bubble = document.getElementById('upsellBubble');
  bubble.classList.add('show');
  clearTimeout(upsellTimeout);
  upsellTimeout = setTimeout(dismissUpsell, 6000);
}

function applyUpsell() {
  if (pendingUpsell) { pendingUpsell.action(); saveCart(); updateCartUI(); renderMenu(); }
  dismissUpsell();
}

function dismissUpsell() {
  document.getElementById('upsellBubble').classList.remove('show');
  clearTimeout(upsellTimeout);
  pendingUpsell = null;
}

function toggleCart() {
  document.getElementById('cartOverlay').classList.toggle('open');
  document.getElementById('cartPanel').classList.toggle('open');
  document.body.style.overflow = document.getElementById('cartPanel').classList.contains('open') ? 'hidden' : '';
}

function saveCart() { localStorage.setItem('be_cart', JSON.stringify(cart)); }

// ===== CLIENT MEMORY =====
function saveClientInfo() {
  const info = {
    prenom: document.getElementById('clientName').value.trim(),
    email: document.getElementById('clientEmail').value.trim(),
    telephone: document.getElementById('clientPhone').value.trim(),
  };
  if (info.prenom || info.email) localStorage.setItem('be_client', JSON.stringify(info));
}

function loadClientInfo() {
  try {
    const info = JSON.parse(localStorage.getItem('be_client'));
    if (!info) return;
    if (info.prenom) document.getElementById('clientName').value = info.prenom;
    if (info.email) document.getElementById('clientEmail').value = info.email;
    if (info.telephone) document.getElementById('clientPhone').value = info.telephone;
  } catch(e) {}
}

function generateTimeSlots() {
  // Time slots are now handled by the custom time picker sheet
}

// ===== ORDER =====
async function submitOrder() {
  const name = document.getElementById('clientName').value.trim();
  const email = document.getElementById('clientEmail').value.trim();
  const phone = document.getElementById('clientPhone').value.trim();
  const pickup = document.getElementById('pickupTime').value;

  if (!name) { alert('Entrez votre pr√©nom'); return; }
  if (!phone) { alert('Entrez votre t√©l√©phone'); return; }
  if (!email || !email.includes('@')) { alert('Entrez un email valide'); return; }
  if (!pickup) { alert('Choisissez une heure de retrait'); return; }
  if (!cart.length) return;

  const btn = document.getElementById('cartSubmit');
  btn.disabled = true; btn.textContent = 'Envoi...';
  saveClientInfo();

  const total = cart.reduce((s, c) => s + c.prix * c.qty, 0);
  const orderNum = 'BE-' + String(Math.floor(Math.random()*9000)+1000);

  const note = document.getElementById('clientNote').value.trim();
  const optin = document.getElementById('optinPromos').checked;

  const orderData = {
    numero: orderNum,
    items: cart.map(c => ({id:c.id, nom:c.nom, prix:c.prix, qty:c.qty})),
    total: Math.round(total*100)/100,
    statut: 'payee',
    heure_retrait: pickup,
    client_prenom: name, client_email: email,
    client_telephone: phone || null,
    note: note || null,
    created_at: new Date().toISOString(),
  };

  if (sb) {
    try {
      await sb.from('clients').upsert({
        email, prenom: name, telephone: phone || null,
        derniere_commande: new Date().toISOString(),
        optin_promo: optin,
      }, {onConflict: 'email'});
      const {error} = await sb.from('orders').insert([orderData]).select();
      if (error) throw error;
      showConfirmation(orderNum);
    } catch (e) {
      console.error('Erreur:', e);
      alert('Erreur, r√©essayez.'); btn.disabled = false; btn.textContent = 'Passer la commande';
    }
  } else {
    setTimeout(() => showConfirmation(orderNum), 600);
  }
}

function showConfirmation(orderNum) {
  toggleCart();
  document.getElementById('confirmOrderNum').textContent = orderNum;
  document.getElementById('confirmTrackBtn').href = `commande.html?num=${orderNum}`;
  document.getElementById('confirmModal').classList.add('open');
  cart = []; saveCart(); updateCartUI(); renderMenu();
  document.getElementById('cartSubmit').disabled = false;
  document.getElementById('cartSubmit').textContent = 'Passer la commande';
  ['clientNote'].forEach(id => document.getElementById(id).value = '');
  // Garder pr√©nom/email/tel en m√©moire pour la prochaine commande
  document.getElementById('optinPromos').checked = false;
}

// ===== NAV =====
function scrollToCat(catId) {
  const el = document.getElementById('cat-' + catId);
  if (el) {
    const navH = document.getElementById('nav').offsetHeight;
    window.scrollTo({top: el.offsetTop - navH - 8, behavior:'smooth'});
  }
  document.querySelectorAll('.nav-cat').forEach(b => b.classList.toggle('active', +b.dataset.cat === catId));
}

function setupScrollSpy() {
  const nav = document.getElementById('nav');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const id = e.target.id.replace('cat-','');
        document.querySelectorAll('.nav-cat').forEach(b => b.classList.toggle('active', b.dataset.cat === id));
        // Auto-scroll nav to active cat
        const active = document.querySelector('.nav-cat.active');
        if (active) active.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
      }
    });
  }, {rootMargin: `-${nav.offsetHeight + 20}px 0px -70% 0px`, threshold:0});
  categories.forEach(cat => {
    const el = document.getElementById('cat-' + cat.id);
    if (el) observer.observe(el);
  });
}

// ===== TIMING =====
let selectedPickup = 'asap';

function updateTimingBar() {
  const open = isOpenNow();
  const dot = document.getElementById('timingDot');
  const text = document.getElementById('timingText');

  if (open) {
    dot.classList.remove('closed');
    const now = new Date();
    const slot = BUSINESS_HOURS.find(s => s[0] === now.getDay());
    text.innerHTML = `Ouvert <small>¬∑ Ferme √† ${slot[3]}h${slot[4] ? String(slot[4]).padStart(2,'0') : '00'}</small>`;
  } else {
    dot.classList.add('closed');
    const next = getNextOpenSlot();
    text.innerHTML = next ? `Ferm√© <small>¬∑ Ouvre ${next.jour} ${next.h}h${next.m ? String(next.m).padStart(2,'0') : '00'}</small>` : 'Ferm√©';
    if (selectedPickup === 'asap') {
      selectedPickup = '';
      document.getElementById('timingPickLabel').textContent = 'Choisir un cr√©neau';
    }
  }
  document.getElementById('pickupTime').value = selectedPickup;
}

// Time picker sheet
let tpDays = [];
let tpSelectedDay = 0;

function openTimePicker() {
  buildTimePicker();
  document.getElementById('tpOverlay').classList.add('open');
  document.getElementById('tpSheet').classList.add('open');
}

function closeTimePicker() {
  document.getElementById('tpOverlay').classList.remove('open');
  document.getElementById('tpSheet').classList.remove('open');
}

function buildTimePicker() {
  const now = new Date();
  const open = isOpenNow();
  document.getElementById('tpAsap').disabled = !open;

  // Build days
  tpDays = [];
  for (let d = 0; d <= 7; d++) {
    const date = new Date(now);
    date.setDate(date.getDate() + d);
    const dayOfWeek = date.getDay();
    const slot = BUSINESS_HOURS.find(s => s[0] === dayOfWeek);
    if (!slot) continue;
    tpDays.push({
      date, dayOfWeek, slot, isToday: d === 0,
      label: d === 0 ? "Aujourd'hui" : d === 1 ? 'Demain' : JOURS[dayOfWeek],
      sub: `${date.getDate()}/${date.getMonth()+1}`
    });
    if (tpDays.length >= 4) break;
  }

  const daysEl = document.getElementById('tpDays');
  daysEl.innerHTML = tpDays.map((day, i) => `
    <div class="timepicker-day ${i === tpSelectedDay ? 'active' : ''}" onclick="selectPickerDay(${i})">
      ${day.label}<small>${day.sub}</small>
    </div>
  `).join('');

  renderTimeSlots();
}

function selectPickerDay(idx) {
  tpSelectedDay = idx;
  document.querySelectorAll('.timepicker-day').forEach((el, i) => el.classList.toggle('active', i === idx));
  renderTimeSlots();
}

function renderTimeSlots() {
  const day = tpDays[tpSelectedDay];
  if (!day) return;
  const now = new Date();
  const slotsEl = document.getElementById('tpSlots');
  const startMin = day.slot[1] * 60 + day.slot[2];
  const endMin = day.slot[3] * 60 + day.slot[4];
  let html = '';
  for (let m = startMin; m <= endMin; m += 15) {
    const h = Math.floor(m / 60), min = m % 60;
    const label = `${h}h${min.toString().padStart(2, '0')}`;
    const isPast = day.isToday && (now.getHours() * 60 + now.getMinutes()) >= m;
    const value = day.isToday ? label : `${day.label} ${label}`;
    html += `<div class="timepicker-slot ${isPast ? 'disabled' : ''} ${selectedPickup === value ? 'active' : ''}"
      onclick="selectTime('${value}')">${label}</div>`;
  }
  slotsEl.innerHTML = html;
}

function selectTime(value) {
  selectedPickup = value;
  document.getElementById('pickupTime').value = value;
  const label = value === 'asap' ? 'D√®s que possible' : value;
  document.getElementById('timingPickLabel').textContent = label;
  closeTimePicker();
}

// ===== UTILS =====
function formatPrice(n) { return n.toFixed(2).replace('.', ',') + ' ‚Ç¨'; }

// ===== SCROLL REVEAL (first load only) =====
let revealDone = false;
function setupScrollReveal() {
  if (revealDone) return;
  revealDone = true;
  // Add reveal class only on first load
  document.querySelectorAll('.menu-card').forEach(card => card.classList.add('reveal'));
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const card = entry.target;
        const siblings = [...card.parentElement.children];
        const idx = siblings.indexOf(card);
        setTimeout(() => card.classList.add('visible'), idx * 60);
        observer.unobserve(card);
      }
    });
  }, {threshold: 0.1, rootMargin: '0px 0px -40px 0px'});
  document.querySelectorAll('.menu-card.reveal').forEach(card => observer.observe(card));
}

document.getElementById('confirmModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('open');
});
</script>
</body>
</html>
