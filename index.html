<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>A Beyrouth ‚Äî Click & Collect | La D√©fense</title>
<meta name="description" content="Commandez en ligne chez A Beyrouth √† La D√©fense. Cuisine libanaise authentique, retrait express.">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßÜ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --dark:#1A1A1A;
  --text:#1A1A1A;--text-soft:#6B6B6B;--text-muted:#ABABAB;
  --bg:#F7F7F5;--white:#FFFFFF;
  --border:#EAEAE8;--border-light:#F3F3F1;
  --green:#1B8C3E;--green-light:#E8F5EC;--green-dark:#157A33;
  --red:#DC2626;
  --gold:#D4AF37;
  --shadow-sm:0 1px 2px rgba(0,0,0,.04);
  --shadow:0 1px 3px rgba(0,0,0,.05),0 2px 8px rgba(0,0,0,.04);
  --shadow-lg:0 8px 24px rgba(0,0,0,.1);
  --r:16px;--r-sm:12px;--r-xs:8px;
}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;color:var(--text);background:var(--bg);line-height:1.5;overflow-x:hidden;-webkit-font-smoothing:antialiased}
button{cursor:pointer;font-family:inherit;border:none;outline:none;background:none}
img{max-width:100%;display:block}
a{color:inherit;text-decoration:none}

/* ===== HEADER ===== */
.header{background:var(--dark);color:#fff;padding:20px 24px}
.header-inner{max-width:1000px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.brand{font-family:'DM Serif Display',Georgia,serif;font-size:1.5rem;font-weight:400;letter-spacing:.3px;line-height:1.2;display:flex;align-items:center;gap:8px}
.brand-express{font-weight:700;font-style:italic;transform:skewX(-8deg);letter-spacing:1px;position:relative;color:var(--gold)}
.brand-express::after{content:'';position:absolute;left:-8px;top:50%;width:6px;height:2px;background:var(--gold);transform:translateY(-50%)}
.brand-express::before{content:'';position:absolute;left:-14px;top:50%;width:4px;height:2px;background:var(--gold);opacity:.6;transform:translateY(-50%)}
.header-right{display:flex;align-items:center;gap:12px}
.header-badge{font-size:.6rem;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;padding:5px 12px;border:1px solid rgba(255,255,255,.2);border-radius:20px;color:rgba(255,255,255,.6)}
.header-status{display:flex;align-items:center;gap:6px;font-size:.82rem;font-weight:500}
.header-status .dot{width:7px;height:7px;border-radius:50%;background:var(--green);flex-shrink:0}
.header-status.closed .dot{background:var(--red)}
.header-sub{font-size:.72rem;opacity:.45;font-weight:400}

/* ===== INFO BAR ===== */
.info-bar{background:var(--white);border-bottom:1px solid var(--border)}
.info-inner{max-width:1000px;margin:0 auto;padding:10px 24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.info-address{display:flex;align-items:center;gap:6px;font-size:.82rem;color:var(--text-soft);transition:color .2s;margin-right:auto}
.info-address:hover{color:var(--dark)}
.info-address svg{width:16px;height:16px;flex-shrink:0;opacity:.5}
.info-time{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:20px;background:var(--border-light);font-size:.82rem;font-weight:600;color:var(--dark);transition:all .15s;cursor:pointer}
.info-time:hover{background:var(--border)}
.info-time svg{width:14px;height:14px;opacity:.5}

/* ===== TIME PICKER ===== */
.timepicker-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:300;opacity:0;pointer-events:none;transition:opacity .3s}
.timepicker-overlay.open{opacity:1;pointer-events:auto}
.timepicker-sheet{position:fixed;bottom:0;left:0;right:0;z-index:301;background:var(--white);border-radius:20px 20px 0 0;padding:20px 20px calc(20px + env(safe-area-inset-bottom,0px));transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);max-height:70vh;overflow-y:auto}
.timepicker-sheet.open{transform:translateY(0)}
.timepicker-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 16px}
.timepicker-title{font-size:1.05rem;font-weight:700;text-align:center;margin-bottom:16px;letter-spacing:-.3px}
.timepicker-asap{width:100%;padding:16px;border-radius:var(--r-sm);font-size:.95rem;font-weight:600;background:var(--green);color:#fff;margin-bottom:6px;transition:all .15s;display:flex;flex-direction:column;align-items:center;gap:2px}
.timepicker-asap:hover{background:var(--green-dark)}
.timepicker-asap:disabled{opacity:.3;cursor:not-allowed}
.timepicker-asap-sub{font-size:.75rem;font-weight:400;opacity:.8}
.timepicker-divider{font-size:.7rem;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);text-align:center;margin:14px 0 12px}
.timepicker-days{display:flex;gap:8px;margin-bottom:14px;overflow-x:auto;padding-bottom:2px}
.timepicker-days::-webkit-scrollbar{display:none}
.timepicker-day{flex-shrink:0;padding:10px 20px;border-radius:20px;font-size:.85rem;font-weight:600;background:var(--border-light);color:var(--dark);cursor:pointer;transition:all .15s;text-align:center}
.timepicker-day.active{background:var(--dark);color:#fff}
.timepicker-day small{display:block;font-size:.7rem;font-weight:400;opacity:.6;margin-top:2px}
.timepicker-slots{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.timepicker-slot{padding:16px 12px;border-radius:var(--r-sm);font-size:1rem;font-weight:600;background:var(--border-light);color:var(--dark);cursor:pointer;text-align:center;transition:all .15s}
.timepicker-slot:hover{background:var(--border);transform:scale(1.02)}
.timepicker-slot.active{background:var(--dark);color:#fff}
.timepicker-slot.disabled{opacity:.3;pointer-events:none}
@media(min-width:640px){.timepicker-slots{grid-template-columns:repeat(4,1fr)}}

/* ===== FORMULE CUSTOMIZER ===== */
.formule-component{margin-bottom:20px}
.formule-component-title{font-size:.85rem;font-weight:600;color:var(--text-soft);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.formule-options{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.formule-option{display:flex;align-items:center;gap:10px;padding:12px;border:2px solid var(--border);border-radius:var(--r-sm);cursor:pointer;transition:all .15s;background:var(--white)}
.formule-option:hover{background:var(--border-light);transform:scale(1.02)}
.formule-option.selected{border-color:var(--green);background:var(--green);color:#fff}
.formule-option{position:relative}
.qty-badge{position:absolute;top:4px;right:4px;background:var(--orange);color:#fff;font-size:.7rem;font-weight:700;padding:2px 6px;border-radius:12px;line-height:1}
.formule-option img{width:40px;height:40px;object-fit:cover;border-radius:8px;flex-shrink:0;overflow:hidden;transform:scale(1.5)}
.formule-option img.sandwich-img{object-position:center 30%}
.formule-option img.boisson-img{transform:scale(1.5)}
.formule-option img.dessert-img{transform:scale(1.5)}
.formule-option-info{flex:1;min-width:0}
.formule-option-name{font-size:.85rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.formule-option-price{font-size:.7rem;opacity:.7}
@media(min-width:500px){.formule-options{grid-template-columns:repeat(3,1fr)}}
.timepicker-slot.disabled{opacity:.2;pointer-events:none}

/* ===== NAV ===== */
.nav{position:sticky;top:0;z-index:100;background:var(--white);border-bottom:1px solid var(--border)}
.nav-inner{max-width:1000px;margin:0 auto;padding:8px 20px;display:flex;align-items:center;gap:6px;overflow-x:auto;scrollbar-width:none}
.nav-inner::-webkit-scrollbar{display:none}
.nav-cat{padding:8px 16px;font-size:.82rem;font-weight:500;white-space:nowrap;color:var(--text-soft);border-radius:20px;transition:all .15s;flex-shrink:0}
.nav-cat:hover{color:var(--dark);background:var(--border-light)}
.nav-cat.active{background:var(--dark);color:var(--white);font-weight:600}

/* ===== MENU ===== */
.menu-section{max-width:1000px;margin:0 auto;padding:16px 16px 100px}
.menu-cat-title{font-size:1.1rem;font-weight:700;margin:28px 0 14px;letter-spacing:-.3px;color:var(--dark);display:flex;align-items:center;gap:10px}
.menu-cat-title::after{content:'';flex:1;height:1px;background:var(--border)}
.menu-cat-title:first-child{margin-top:8px}
.menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:8px}
.menu-card{position:relative;border-radius:var(--r);overflow:hidden;background:var(--white);box-shadow:var(--shadow-sm);cursor:pointer;transition:transform .2s,box-shadow .2s;-webkit-tap-highlight-color:transparent}
.menu-card.reveal{opacity:0;transform:translateY(16px);transition:transform .45s cubic-bezier(.4,0,.2,1),box-shadow .2s,opacity .45s}
.menu-card.reveal.visible{opacity:1;transform:translateY(0)}
.menu-card:active{transform:scale(.97)}
@media(hover:hover){.menu-card:hover{box-shadow:var(--shadow);transform:translateY(-2px)}}
.menu-card-visual{width:100%;aspect-ratio:4/3;background:linear-gradient(145deg,#F5F0EB,#EDE6DE);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.menu-card-visual img{width:100%;height:100%;object-fit:cover}
.emoji-placeholder{font-size:2.5rem;opacity:.7}
.menu-card-body{padding:10px 12px 12px}
.menu-card-name{font-weight:600;font-size:.88rem;line-height:1.25;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;letter-spacing:-.2px}
.menu-card-desc{font-size:.72rem;color:var(--text-soft);line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:6px}
.menu-card-bottom{display:flex;align-items:center;justify-content:space-between}
.menu-card-price{font-weight:700;font-size:.92rem;color:var(--dark)}
.menu-card-add{position:absolute;top:8px;right:8px;width:36px;height:36px;border-radius:50%;background:var(--white);box-shadow:0 2px 8px rgba(0,0,0,.12);font-size:1.3rem;display:flex;align-items:center;justify-content:center;transition:all .15s;font-weight:600;color:var(--dark);z-index:2;-webkit-tap-highlight-color:transparent}
@media(hover:hover){.menu-card-add:hover{background:var(--dark);color:var(--white);transform:scale(1.1)}}
.menu-card-unavailable{opacity:.35;pointer-events:none}
.menu-card-unavailable .menu-card-add{display:none}
.menu-card-stepper{position:absolute;top:8px;right:8px;z-index:2;display:flex;align-items:center;background:var(--white);border-radius:20px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.menu-card-stepper button{width:34px;height:34px;font-size:1rem;font-weight:600;background:none;display:flex;align-items:center;justify-content:center;transition:background .1s;-webkit-tap-highlight-color:transparent}
.menu-card-stepper button:first-child{color:var(--red)}
.menu-card-stepper button:last-child{color:var(--green)}
.menu-card-stepper button:active{background:var(--border-light);border-radius:50%}
.menu-card-stepper span{min-width:22px;text-align:center;font-weight:700;font-size:.85rem}

/* ===== BOTTOM BAR ===== */
.bottom-bar{position:fixed;bottom:0;left:0;right:0;z-index:150;padding:12px 20px calc(12px + env(safe-area-inset-bottom,0px));background:var(--white);border-top:1px solid var(--border);transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1)}
.bottom-bar.show{transform:translateY(0)}
.bottom-bar-inner{max-width:1000px;margin:0 auto}
.bottom-bar-btn{width:100%;padding:16px 20px;background:var(--dark);color:#fff;border-radius:var(--r-sm);font-size:.95rem;font-weight:600;display:flex;align-items:center;justify-content:space-between;transition:all .15s}
.bottom-bar-btn:hover{background:#000}
.bottom-bar-count{background:rgba(255,255,255,.2);padding:2px 10px;border-radius:20px;font-size:.82rem}
.bottom-bar-total{font-size:.95rem;font-weight:700}

/* ===== CART ===== */
.cart-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;opacity:0;pointer-events:none;transition:opacity .3s}
.cart-overlay.open{opacity:1;pointer-events:auto}
.cart-panel{position:fixed;top:0;right:0;bottom:0;width:min(440px,100vw);background:var(--white);z-index:201;transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column}
.cart-panel.open{transform:translateX(0)}
.cart-header{padding:20px 20px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
.cart-header h3{font-size:1.1rem;font-weight:700;letter-spacing:-.3px}
.cart-close{background:var(--border-light);width:40px;height:40px;border-radius:50%;font-size:1.3rem;display:flex;align-items:center;justify-content:center;transition:background .15s;color:var(--text-soft)}
.cart-close:hover{background:var(--border)}
.cart-body{flex:1;overflow-y:auto}
.cart-items{padding:12px 20px}
.cart-empty{text-align:center;padding:48px 20px;color:var(--text-muted);font-size:.9rem}
.cart-item{display:flex;gap:12px;padding:14px 0;border-bottom:1px solid var(--border-light);align-items:center}
.cart-item:last-child{border-bottom:none}
.cart-item-emoji{font-size:1.5rem;width:40px;height:40px;background:linear-gradient(145deg,#F5F0EB,#EDE6DE);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.cart-item-info{flex:1;min-width:0}
.cart-item-name{font-weight:600;font-size:.88rem;letter-spacing:-.2px}
.cart-item-price{font-size:.78rem;color:var(--text-soft);font-weight:400;margin-top:1px}
.cart-item-qty{display:flex;align-items:center;gap:8px;flex-shrink:0}
.cart-item-qty button{width:32px;height:32px;border-radius:50%;background:var(--border-light);font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .15s;font-weight:600}
.cart-item-qty button:hover{background:var(--border);transform:scale(1.05)}
.cart-item-qty span{font-weight:700;min-width:20px;text-align:center;font-size:.88rem}

/* ===== CART FOOTER ===== */
.cart-footer{padding:16px 20px;background:var(--white)}
.cart-subtotal{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding:14px 16px;background:var(--border-light);border-radius:var(--r-sm);font-size:.88rem;color:var(--text-soft)}
.cart-subtotal strong{color:var(--dark);font-size:1.1rem}
.cart-form{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.cart-form input,.cart-form select,.cart-form textarea{padding:13px 16px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:.88rem;font-family:inherit;background:var(--white);transition:border-color .15s}
.cart-form input:focus,.cart-form select:focus,.cart-form textarea:focus{border-color:var(--dark);outline:none}
.cart-form input::placeholder,.cart-form textarea::placeholder{color:var(--text-muted)}
.cart-form .form-row{display:flex;gap:8px}
.cart-form .form-row>*{flex:1}
.cart-form textarea{resize:none;min-height:56px}
.cart-checkout-btn{width:100%;padding:16px;background:var(--dark);color:#fff;border-radius:var(--r-sm);font-size:1rem;font-weight:600;transition:all .15s;letter-spacing:.2px}
.cart-checkout-btn:hover{background:#000;transform:translateY(-1px)}
.cart-checkout-btn:disabled{opacity:.3;cursor:not-allowed;transform:none}
.cart-pay-info{font-size:.72rem;color:var(--text-muted);text-align:center;margin-top:8px}
.cart-form-info{font-size:.78rem;color:var(--green);font-weight:500;margin:2px 0 0;line-height:1.4}
.cart-optin{display:flex;align-items:flex-start;gap:8px;font-size:.78rem;color:var(--text-soft);cursor:pointer;margin-top:2px}
.cart-optin input[type=checkbox]{width:18px;height:18px;accent-color:var(--green);flex-shrink:0;margin-top:1px}

/* ===== SUGGESTIONS ===== */
.cart-suggest{padding:0 20px 8px}
.cart-suggest-title{font-size:.75rem;font-weight:600;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.cart-suggest-list{display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:4px}
.cart-suggest-list::-webkit-scrollbar{display:none}
.cart-suggest-item{flex-shrink:0;display:flex;align-items:center;gap:8px;background:var(--border-light);border-radius:var(--r-sm);padding:8px 12px;cursor:pointer;transition:all .15s;font-size:.82rem}
.cart-suggest-item:hover{background:var(--border);transform:translateY(-1px)}
.cart-suggest-item:active{transform:scale(.97)}
.suggest-emoji{font-size:1.2rem}
.suggest-name{font-weight:600;white-space:nowrap}
.suggest-price{color:var(--text-soft);font-size:.72rem;white-space:nowrap}
.suggest-add{width:24px;height:24px;border-radius:50%;background:var(--dark);color:#fff;font-size:.8rem;display:flex;align-items:center;justify-content:center;font-weight:600}

/* ===== UPSELL BUBBLE ===== */
.upsell-bubble{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(120px);z-index:160;background:var(--dark);color:#fff;padding:14px 20px;border-radius:var(--r);box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:12px;max-width:min(400px,calc(100vw - 32px));transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .3s;opacity:0;pointer-events:none}
.upsell-bubble.show{transform:translateX(-50%) translateY(0);opacity:1;pointer-events:auto}
.upsell-bubble-emoji{font-size:1.5rem;flex-shrink:0}
.upsell-bubble-text{flex:1;font-size:.82rem;line-height:1.35}
.upsell-bubble-text strong{color:var(--green);font-weight:600}
.upsell-bubble-btn{background:var(--green);color:#fff;padding:8px 16px;border-radius:20px;font-size:.78rem;font-weight:600;white-space:nowrap;transition:all .15s;flex-shrink:0}
.upsell-bubble-btn:hover{background:var(--green-dark)}
.upsell-bubble-close{position:absolute;top:-8px;right:-8px;width:22px;height:22px;background:#555;color:#fff;border-radius:50%;font-size:.7rem;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .15s}
.upsell-bubble-close:hover{background:#777}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:300;display:none;align-items:center;justify-content:center;padding:24px}
.modal-overlay.open{display:flex}
.modal{background:var(--white);border-radius:var(--r);padding:36px 32px;max-width:380px;width:100%;text-align:center;animation:modalIn .3s ease-out}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:none}}
.modal-icon{width:64px;height:64px;border-radius:50%;background:var(--green-light);color:var(--green);display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin:0 auto 16px}
.modal h3{font-size:1.15rem;font-weight:700;margin-bottom:4px}
.modal-order-num{font-size:1.8rem;font-weight:700;color:var(--dark);margin:8px 0}
.modal p{color:var(--text-soft);font-size:.88rem;margin-bottom:16px;line-height:1.5}
.modal-btn{display:inline-block;padding:14px 28px;background:var(--dark);color:#fff;border-radius:var(--r-sm);font-weight:600;font-size:.9rem;transition:all .15s}
.modal-btn:hover{background:#000}

/* ===== FOOTER ===== */
.footer{background:var(--dark);color:#fff;padding:40px 24px;text-align:center}
.footer-inner{max-width:600px;margin:0 auto}
.footer-brand{font-family:'DM Serif Display',Georgia,serif;font-size:1.2rem;margin-bottom:4px}
.footer-sub{font-size:.78rem;opacity:.5;margin-bottom:16px}
.footer-address{font-size:.78rem;opacity:.4;margin-bottom:4px}
.footer-hours{font-size:.78rem;opacity:.4;margin-bottom:16px}
.footer-link{font-size:.72rem;opacity:.3}

/* ===== RESPONSIVE ===== */
@media(min-width:640px){
  .menu-grid{grid-template-columns:repeat(3,1fr);gap:14px}
  .menu-card-visual{aspect-ratio:1}
  .timepicker-slots{grid-template-columns:repeat(4,1fr)}
}
@media(min-width:900px){
  .menu-grid{grid-template-columns:repeat(4,1fr)}
}
@media(max-width:640px){
  .header{padding:16px}
  .header-inner{flex-wrap:wrap;gap:8px}
  .brand{font-size:1.3rem}
  .info-inner{padding:8px 16px;gap:10px}
  .info-address{font-size:.78rem}
  .nav-inner{padding:6px 12px}
  .nav-cat{padding:7px 14px;font-size:.78rem}
  .menu-section{padding:10px 10px calc(90px + env(safe-area-inset-bottom,0px))}
  .menu-cat-title{font-size:1rem;margin:20px 0 10px}
  .menu-grid{gap:8px}
  .menu-card-body{padding:8px 10px 10px}
  .menu-card-name{font-size:.82rem}
  .menu-card-desc{display:none}
  .menu-card-price{font-size:.85rem}
  .menu-card-add{width:34px;height:34px;font-size:1.1rem}
  .menu-card-stepper button{width:30px;height:30px;font-size:.9rem}
  .bottom-bar{padding:10px 16px calc(10px + env(safe-area-inset-bottom,0px))}
  .cart-panel{width:100vw}
  .cart-footer{padding-bottom:calc(16px + env(safe-area-inset-bottom,0px))}
  .cart-form .form-row{flex-direction:column;gap:8px}
}
@media(max-width:380px){
  .menu-grid{gap:6px}
  .menu-card-body{padding:6px 8px 8px}
  .menu-card-name{font-size:.78rem}
  .menu-card-price{font-size:.82rem}
}

/* ===== TOAST NOTIFICATIONS ===== */
#toastContainer{position:fixed;bottom:calc(90px + env(safe-area-inset-bottom,0px));left:50%;transform:translateX(-50%);z-index:10000;display:flex;flex-direction:column;gap:12px;pointer-events:none;width:calc(100% - 32px);max-width:400px}
.toast{background:var(--dark);color:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.2),0 0 0 1px rgba(255,255,255,.1) inset;font-size:.9rem;font-weight:500;pointer-events:auto;transform:translateY(100px);opacity:0;transition:all .4s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;gap:12px;line-height:1.4}
.toast.show{transform:translateY(0);opacity:1}
.toast.hide{transform:translateY(20px);opacity:0}
.toast-icon{font-size:1.3rem;flex-shrink:0}
.toast-message{flex:1}
.toast.error{background:linear-gradient(135deg,#DC2626,#B91C1C)}
.toast.success{background:linear-gradient(135deg,#1B8C3E,#157A33)}
.toast.warning{background:linear-gradient(135deg,#F59E0B,#D97706)}
@media(min-width:640px){#toastContainer{top:20px;bottom:auto}.toast{transform:translateY(-100px)}.toast.hide{transform:translateY(-20px)}}
</style>
</head>
<body>
<div id="toastContainer"></div>

<!-- HEADER -->
<header class="header">
  <div class="header-inner">
    <h1 class="brand">
      <span>BEYROUTH</span>
      <span class="brand-express">EXPRESS</span>
    </h1>
    <div class="header-right">
      <a href="/traiteur" style="font-size:.8rem;font-weight:500;opacity:.7;margin-right:8px;text-decoration:underline;text-decoration-color:rgba(255,255,255,.3);transition:opacity .2s" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.7'">Traiteur</a>
      <span class="header-badge">Click & Collect</span>
      <div class="header-status" id="headerStatus">
        <span class="dot"></span>
        <span id="statusText">Ouvert</span>
        <span id="headerHours" class="header-sub"></span>
      </div>
    </div>
  </div>
</header>

<!-- INFO BAR -->
<div class="info-bar">
  <div class="info-inner">
    <a class="info-address" href="https://www.google.com/maps/search/A+Beyrouth+1+Esplanade+du+General+de+Gaulle+92800+Puteaux" target="_blank" rel="noopener">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
      La D√©fense ‚Äî Sortie 4 M√©tro
    </a>
    <button class="info-time" onclick="openTimePicker()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
      <span id="timingPickLabel">D√®s que possible</span>
      <span style="font-size:.65rem;opacity:.4">&#9662;</span>
    </button>
  </div>
</div>

<!-- Hidden elements for JS compatibility -->
<span id="timingDot" hidden></span>
<span id="timingText" hidden></span>

<!-- TIME PICKER -->
<div class="timepicker-overlay" id="tpOverlay" onclick="closeTimePicker()"></div>
<div class="timepicker-sheet" id="tpSheet">
  <div class="timepicker-handle"></div>
  <div class="timepicker-title">Heure de retrait</div>
  <button class="timepicker-asap" id="tpAsap" onclick="selectTime('asap')">
    D√®s que possible
    <span class="timepicker-asap-sub">~15 min de pr√©paration</span>
  </button>
  <div class="timepicker-divider">ou choisir un cr√©neau</div>
  <div class="timepicker-days" id="tpDays"></div>
  <div class="timepicker-slots" id="tpSlots"></div>
</div>

<!-- FORMULE CUSTOMIZER -->
<div class="timepicker-overlay" id="formuleOverlay" onclick="closeFormuleModal()"></div>
<div class="timepicker-sheet" id="formuleSheet">
  <div class="timepicker-handle"></div>
  <div class="timepicker-title" id="formuleTitle">Personnalisez votre formule</div>
  <div id="formuleComponents" style="padding:10px 0"></div>
  <button class="cart-checkout-btn" id="formuleAddBtn" onclick="addFormuleToCart()" disabled>
    Ajouter au panier
  </button>
</div>

<!-- NAV -->
<nav class="nav" id="nav">
  <div class="nav-inner" id="navCats"></div>
</nav>

<!-- MENU -->
<section class="menu-section" id="menu">
  <div id="menuContent"></div>
</section>

<!-- BOTTOM BAR -->
<div class="bottom-bar" id="bottomBar">
  <div class="bottom-bar-inner">
    <button class="bottom-bar-btn" onclick="toggleCart()">
      <span>Voir le panier <span class="bottom-bar-count" id="bottomCount">0</span></span>
      <span class="bottom-bar-total" id="bottomTotal">0,00 ‚Ç¨</span>
    </button>
  </div>
</div>

<!-- CART -->
<div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
<div class="cart-panel" id="cartPanel">
  <div class="cart-header">
    <h3>Votre commande</h3>
    <button class="cart-close" onclick="toggleCart()">&times;</button>
  </div>
  <div class="cart-body">
    <div class="cart-items" id="cartItems">
      <div class="cart-empty" id="cartEmpty">Votre panier est vide</div>
    </div>
    <div class="cart-suggest" id="cartSuggest" style="display:none">
      <div class="cart-suggest-title">Vous aimerez aussi</div>
      <div class="cart-suggest-list" id="cartSuggestList"></div>
    </div>
    <div class="cart-footer" id="cartFooter" style="display:none">
      <div class="cart-subtotal">
        <span>Total</span>
        <strong id="cartTotal">0,00 ‚Ç¨</strong>
      </div>

      <!-- Heure de retrait -->
      <div style="background:var(--green-light);border-radius:var(--r-sm);padding:12px 16px;margin:12px 0 16px;display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:10px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          <div>
            <div style="font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--green);opacity:.7;">Retrait pr√©vu</div>
            <div style="font-size:.95rem;font-weight:700;color:var(--green);margin-top:2px;" id="cartPickupDisplay">D√®s que possible</div>
          </div>
        </div>
        <button onclick="openTimePicker()" style="background:var(--green);color:white;padding:6px 12px;border-radius:6px;font-size:.8rem;font-weight:600;">Modifier</button>
      </div>

      <div class="cart-form">
        <input type="hidden" id="pickupTime" value="">
        <input type="text" id="clientName" placeholder="Pr√©nom" required>
        <div class="form-row">
          <input type="tel" id="clientPhone" placeholder="T√©l√©phone" required>
          <input type="email" id="clientEmail" placeholder="Email" required>
        </div>
        <textarea id="clientNote" placeholder="Note : allergies, sans oignon, etc."></textarea>
        <label class="cart-optin">
          <input type="checkbox" id="wantReceipt" checked>
          <span>Recevoir mon re√ßu par email</span>
        </label>
        <label class="cart-optin">
          <input type="checkbox" id="optinPromos" checked>
          <span>Me tenir inform√© des offres et promotions</span>
        </label>
      </div>
      <button class="cart-checkout-btn" id="cartSubmit" onclick="submitOrder()">
        Passer la commande
      </button>
      <p class="cart-pay-info">Paiement en ligne s√©curis√© (CB, carte restaurant)</p>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-icon">&#10003;</div>
    <h3>Commande envoy√©e !</h3>
    <div class="modal-order-num" id="confirmOrderNum">BE-0001</div>
    <p style="font-size:.82rem;color:#6B6B6B;margin:8px 0 0;">Code de retrait</p>
    <div id="confirmCode" style="font-size:2.5rem;font-weight:700;color:#1B8C3E;margin:8px 0 12px;letter-spacing:6px;display:none;">----</div>
    <p id="confirmText">Commande enregistr√©e !<br>Un email de confirmation vous a √©t√© envoy√©.</p>
    <a class="modal-btn" id="confirmTrackBtn" href="commande.html">Suivre ma commande</a>
  </div>
</div>

<!-- UPSELL -->
<div class="upsell-bubble" id="upsellBubble">
  <span class="upsell-bubble-emoji" id="upsellEmoji"></span>
  <div class="upsell-bubble-text" id="upsellText"></div>
  <button class="upsell-bubble-btn" id="upsellBtn" onclick="applyUpsell()">Ajouter</button>
  <div class="upsell-bubble-close" onclick="dismissUpsell()">&times;</div>
</div>

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-inner">
    <p class="footer-brand">Beyrouth Express</p>
    <p class="footer-sub">Service en ligne de A Beyrouth</p>
    <p class="footer-address">1 Esplanade du G√©n√©ral de Gaulle, 92800 Puteaux</p>
    <p class="footer-hours">Lun‚ÄìVen 11h‚Äì15h</p>
    <div style="margin:16px 0">
      <a href="traiteur.html" style="display:inline-block;background:var(--gold);color:var(--dark);padding:10px 24px;border-radius:8px;font-weight:600;font-size:.9rem;transition:all .2s">
        üçΩÔ∏è Service Traiteur
      </a>
    </div>
    <p class="footer-link">beyrouth.express</p>
  </div>
</footer>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<!-- PAYGREEN -->
<script src="https://paygreen.fr/js/sdk.js"></script>
<script>
// ===== CONFIG =====
const SUPABASE_URL = 'https://xbuftfwcyontgqbbrrjt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhidWZ0ZndjeW9udGdxYmJycmp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2Njg1NzksImV4cCI6MjA4NjI0NDU3OX0.ROkSccADlpLsWMgqyiX_xNaFdJNR8P4R-LJCnZV2Gzg';
const PAYGREEN_PUBLIC_KEY = 'pk_28b9dcb7b9604b3d9efb03c2e2a2bd45';
const PAYGREEN_SHOP_ID = 'sh_55f9f298d8ce478db7b87117ec86ce11';
const IMAGE_VERSION = Date.now(); // Cache busting version - d√©fini une seule fois au chargement
let sb = null;
let paygreen = null;
try { sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null; } catch(e) { console.error('Supabase init error:', e); }
try { if (window.Paygreen) paygreen = new window.Paygreen(PAYGREEN_PUBLIC_KEY); } catch(e) { console.error('Paygreen init error:', e); }

// ===== STATE =====
let categories = [];
let menuItems = [];
let ingredients = [];
let cart = JSON.parse(localStorage.getItem('be_cart') || '[]');

// ===== FORMULE CONFIGS =====
const FORMULE_CONFIG = {
  'Formule 1': [
    { name: 'Sandwich', category: 1, qty: 1 },
    { name: 'Feuillet√©s', items: ['Fromage', 'Boeuf', '√âpinard', 'Falafel'], qty: 2 },
    { name: 'Boisson', category: 7, qty: 1 }
  ],
  'Formule 2': [
    { name: 'Sandwich', category: 1, qty: 1 },
    { name: 'Entr√©e froide', items: ['Houmous', 'Moutabal', 'Taboul√©'], qty: 1 },
    { name: 'Boisson', category: 7, qty: 1 }
  ],
  'Formule 3': [
    { name: 'Sandwich', category: 1, qty: 1 },
    { name: 'Dessert', category: 6, qty: 1 },
    { name: 'Boisson', category: 7, qty: 1 }
  ],
  'Formule 4': [
    { name: 'Sandwich', category: 1, qty: 2 },
    { name: 'Boisson', category: 7, qty: 1 }
  ]
};

// ===== IMAGE MAPPINGS FOR FEUILLET√âS & ENTR√âES =====
const ITEM_IMAGES = {
  'Fromage': 'img/sambousek-fromage.jpg',
  'Boeuf': 'img/sambousek-viande.jpg',
  '√âpinard': 'img/feuillete-epinard.jpg',
  'Falafel': 'img/falafel.jpg',
  'Houmous': 'img/houmous.jpg',
  'Moutabal': 'img/moutabal.jpg',
  'Taboul√©': 'img/taboule.jpg'
};

// ===== DEMO DATA =====
const DEMO_CATEGORIES = [
  {id:2, nom:'Formules', ordre:1, emoji:'üçΩÔ∏è'},
  {id:1, nom:'Sandwichs', ordre:2, emoji:'üåØ'},
  {id:3, nom:'Grillades', ordre:3, emoji:'üî•'},
  {id:4, nom:'Plateaux', ordre:4, emoji:'ü•ò'},
  {id:5, nom:'Entr√©es Froides', ordre:5, emoji:'üßÜ'},
  {id:13, nom:'Entr√©es Chaudes', ordre:6, emoji:'ü•ü'},
  {id:6, nom:'Desserts', ordre:7, emoji:'üçÆ'},
  {id:7, nom:'Boissons', ordre:8, emoji:'ü•§'},
  {id:14, nom:'Sauces', ordre:9, emoji:'üßâ'},
];

const DEMO_ITEMS = [
  {id:1, categorie_id:1, nom:'Shawarma Poulet', description:'√âminc√© de poulet marin√©, crudit√©s, sauce maison', prix:6.90, emoji:'üåØ', image_url:'img/sandwich-shawarma.jpg', disponible:true},
  {id:2, categorie_id:1, nom:'Chich Taouk', description:'Brochette de blanc de poulet marin√©', prix:6.90, emoji:'üåØ', image_url:'img/sandwich-chich-taouk.jpg', disponible:true},
  {id:3, categorie_id:1, nom:'Shawarma Boeuf', description:'√âminc√© de boeuf marin√©, crudit√©s, sauce maison', prix:6.90, emoji:'üåØ', image_url:'img/sandwich-boeuf.jpg', disponible:true},
  {id:4, categorie_id:1, nom:'Falafel', description:'Boulette de f√®ves et pois chiches', prix:6.90, emoji:'üßÜ', image_url:'img/sandwich-falafel.jpg', disponible:true},
  {id:5, categorie_id:1, nom:'Veggie', description:'Chou fleur, aubergine, crudit√©s', prix:6.90, emoji:'ü•¨', image_url:'img/sandwich-veggie.jpg', disponible:true},
  {id:6, categorie_id:1, nom:'Foie de Volaille', description:'Marin√© au citron', prix:6.90, emoji:'üçó', image_url:'img/sandwich-foie-volaille.jpg', disponible:true},
  {id:7, categorie_id:1, nom:'Kafta', description:'Brochette de boeuf hach√©e persill√©e', prix:6.90, emoji:'üç¢', image_url:'img/sandwich-kafta.jpg', disponible:true},
  {id:8, categorie_id:1, nom:'Soujouk', description:'Saucisses de boeuf √©pic√©es', prix:6.90, emoji:'üå≠', image_url:'img/sandwich-soujouk.jpg', disponible:true},
  {id:10, categorie_id:2, nom:'Formule 1', description:'Sandwich + 2 feuillet√©s + boisson', prix:10.90, emoji:'1Ô∏è‚É£', image_url:'img/formule-1.jpg', disponible:true},
  {id:11, categorie_id:2, nom:'Formule 2', description:'Sandwich + entr√©e froide + boisson', prix:11.90, emoji:'2Ô∏è‚É£', image_url:'img/formule-2.jpg', disponible:true},
  {id:12, categorie_id:2, nom:'Formule 3', description:'Sandwich + dessert + boisson', prix:11.90, emoji:'3Ô∏è‚É£', image_url:'img/formule-3.jpg', disponible:true},
  {id:13, categorie_id:2, nom:'Formule 4', description:'2 sandwiches au choix + boisson', prix:14.90, emoji:'4Ô∏è‚É£', image_url:'img/formule-4.jpg', disponible:true},
  {id:14, categorie_id:2, nom:'Formule Plat du Jour', description:'Plat du jour + boisson', prix:13.90, emoji:'üçΩÔ∏è', disponible:true},
  {id:20, categorie_id:3, nom:'Kafta M√©choui', description:'2 brochettes boeuf, riz, crudit√©s', prix:13.00, emoji:'üç¢', image_url:'img/kafta-mechoui.jpg', disponible:true},
  {id:21, categorie_id:3, nom:'Chich Taouk', description:'2 brochettes poulet, riz, crudit√©s', prix:13.00, emoji:'üçó', image_url:'img/chich-taouk.jpg', disponible:true},
  {id:22, categorie_id:3, nom:'Shawarma Poulet ou Boeuf', description:'√âminc√© marin√© grill√© √† la broche, riz, crudit√©s', prix:15.00, emoji:'üåØ', image_url:'img/shawarma-poulet.jpg', disponible:true},
  {id:24, categorie_id:3, nom:'Grillade Mixte', description:'Shawarma poulet, kafta, chich taouk, riz, crudit√©s', prix:16.00, emoji:'üî•', disponible:true},
  {id:30, categorie_id:4, nom:'Beyrouth Poulet', description:'Houmous, moutabal, taboul√©, shawarma poulet, riz', prix:14.00, emoji:'ü•ò', disponible:true},
  {id:31, categorie_id:4, nom:'Beyrouth Boeuf', description:'Houmous, moutabal, taboul√©, shawarma boeuf, riz', prix:15.00, emoji:'ü•ò', disponible:true},
  {id:32, categorie_id:4, nom:'V√©g√©tarienne', description:'Houmous, moutabal, moussaka, crudit√©s, 3 feuillet√©s v√©g√©tariens', prix:14.00, emoji:'ü•¨', disponible:true},
  {id:33, categorie_id:4, nom:'Falafel', description:'Houmous, moutabal, taboul√©, crudit√©s, 3 falafels', prix:14.00, emoji:'üßÜ', disponible:true},
  {id:34, categorie_id:4, nom:'Liban', description:'Houmous, moutabal, chich taouk, riz, crudit√©s, 2 feuillet√©s v√©g√©tariens', prix:16.00, emoji:'üá±üáß', disponible:true},
  {id:35, categorie_id:4, nom:'Byblos', description:'Houmous, moutabal, taboul√©, 3 feuillet√©s v√©g√©tariens, kafta, chich taouk, shawarma poulet, riz', prix:18.00, emoji:'üëë', disponible:true},
  {id:40, categorie_id:5, nom:'Houmous', description:'Pur√©e de pois chiches au tahini, parfum√©e au citron et √† l\'huile d\'olive', prix:6.00, emoji:'ü´ò', image_url:'img/houmous.jpg', disponible:true},
  {id:41, categorie_id:5, nom:'Moutabal', description:'Caviar d\'aubergines r√¥ties √† la cr√®me de s√©same, jus de citron', prix:6.00, emoji:'üçÜ', image_url:'img/moutabal.jpg', disponible:true},
  {id:42, categorie_id:5, nom:'Taboul√©', description:'Salade de persil, tomates, oignons, bl√© concass√©, huile d\'olive, citron', prix:6.00, emoji:'ü•ó', image_url:'img/taboule.jpg', disponible:true},
  {id:43, categorie_id:5, nom:'Salade du Moine', description:'Aubergines grill√©es, tomates, persil, poivrons, huile d\'olive, jus de citron', prix:6.00, emoji:'ü•ó', image_url:'img/salade-moine.jpg', disponible:true},
  {id:44, categorie_id:5, nom:'Moussaka', description:'Aubergines au four, cuisin√©es √† la sauce tomate, pois chiches', prix:7.50, emoji:'üç≤', image_url:'img/plat-jour.jpg', disponible:true},
  {id:45, categorie_id:5, nom:'Feuilles de Vignes', description:'Farcies de riz, huile d\'olive, citron', prix:6.00, emoji:'üåø', image_url:'img/feuilles-vigne.jpg', disponible:true},
  {id:70, categorie_id:13, nom:'Falafel (pi√®ce)', description:'F√®ves et pois chiches √† la coriandre', prix:1.50, emoji:'üßÜ', image_url:'img/falafel.jpg', disponible:true},
  {id:71, categorie_id:13, nom:'Fattayer', description:'Chaussons aux √©pinards acidul√©s', prix:1.50, emoji:'ü•ü', image_url:'img/fattayer.jpg', disponible:true},
  {id:72, categorie_id:13, nom:'Samboussek Fromage', description:'Fromage de feta', prix:1.50, emoji:'ü•ü', image_url:'img/sambousek-fromage.jpg', disponible:true},
  {id:73, categorie_id:13, nom:'Rikakat Fromage', description:'Fromage de feta', prix:2.00, emoji:'üßÄ', image_url:'img/rkakat.jpg', disponible:true},
  {id:74, categorie_id:13, nom:'Samboussek Viande', description:'Viande de boeuf hach√©', prix:1.50, emoji:'ü•ü', image_url:'img/sambousek-viande.jpg', disponible:true},
  {id:75, categorie_id:13, nom:'Kebb√©', description:'Boulette de bl√© concass√© farcies de viande hach√©e', prix:2.50, emoji:'üç°', image_url:'img/kebbe.jpg', disponible:true},
  {id:50, categorie_id:6, nom:'Mouhalabieh', description:'Flan fleur d\'oranger, pistaches (fait maison)', prix:4.00, emoji:'üçÆ', image_url:'img/mouhalabieh.jpg', disponible:true},
  {id:51, categorie_id:6, nom:'Namoura', description:'G√¢teau de semoule, sirop fleur d\'oranger', prix:4.00, emoji:'üç∞', image_url:'img/namoura.jpg', disponible:true},
  {id:52, categorie_id:6, nom:'Baklawas', description:'Bo√Æte de 3 pi√®ces', prix:4.50, emoji:'üçØ', image_url:'img/baklawas.jpg', disponible:true},
  {id:53, categorie_id:6, nom:'Duo Sabl√©s', description:'2 sabl√©s : pistaches, amandes, noix ou dattes', prix:5.00, emoji:'üç™', image_url:'img/duo-sables.jpg', disponible:true},
  {id:60, categorie_id:7, nom:'Coca-Cola', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/coca.jpg', disponible:true},
  {id:61, categorie_id:7, nom:'Fanta', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/fanta.jpg', disponible:true},
  {id:62, categorie_id:7, nom:'Oasis Tropical', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/oasis.jpg', disponible:true},
  {id:63, categorie_id:7, nom:'Lipton P√™che', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/lipton.jpg', disponible:true},
  {id:64, categorie_id:7, nom:'7Up', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/7up.jpg', disponible:true},
  {id:65, categorie_id:7, nom:'Coca-Cola Zero', description:'Canette 33cl', prix:2.00, emoji:'ü•§', image_url:'img/coca-zero.jpg', disponible:true},
  {id:66, categorie_id:7, nom:'Perrier', description:'Canette 33cl', prix:2.00, emoji:'ü´ß', image_url:'img/perrier.jpg', disponible:true},
  {id:67, categorie_id:7, nom:'Ayran', description:'Yaourt sal√©, rafra√Æchissant', prix:2.50, emoji:'ü•õ', disponible:true},
  {id:68, categorie_id:7, nom:'Eau Plate', description:'50cl', prix:2.00, emoji:'üíß', image_url:'img/eau.jpg', disponible:true},
];

// ===== HORAIRES =====
const BUSINESS_HOURS = [
  [1, 11, 0, 15, 0],
  [2, 11, 0, 15, 0],
  [3, 11, 0, 15, 0],
  [4, 11, 0, 15, 0],
  [5, 11, 0, 15, 0],
];
const JOURS = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

function isOpenNow() {
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const slot = BUSINESS_HOURS.find(s => s[0] === day);
  if (!slot) return false;
  const nowMin = h * 60 + m;
  return nowMin >= slot[1] * 60 + slot[2] && nowMin < slot[3] * 60 + slot[4];
}

function getNextOpenSlot() {
  const now = new Date();
  const day = now.getDay();
  const h = now.getHours(), m = now.getMinutes();
  const nowMin = h * 60 + m;
  const today = BUSINESS_HOURS.find(s => s[0] === day);
  if (today && nowMin < today[1] * 60 + today[2]) {
    return {jour: JOURS[day], h: today[1], m: today[2]};
  }
  for (let i = 1; i <= 7; i++) {
    const d = (day + i) % 7;
    const slot = BUSINESS_HOURS.find(s => s[0] === d);
    if (slot) return {jour: JOURS[d], h: slot[1], m: slot[2]};
  }
  return null;
}

function updateOpenStatus() {
  const statusEl = document.getElementById('headerStatus');
  const textEl = document.getElementById('statusText');
  const hoursEl = document.getElementById('headerHours');
  const open = isOpenNow();
  if (open) {
    statusEl.classList.remove('closed');
    textEl.textContent = 'Ouvert';
    const now = new Date();
    const slot = BUSINESS_HOURS.find(s => s[0] === now.getDay());
    hoursEl.textContent = `¬∑ Jusqu'√† ${slot[3]}h${slot[4] ? String(slot[4]).padStart(2,'0') : '00'}`;
  } else {
    statusEl.classList.add('closed');
    textEl.textContent = 'Ferm√©';
    const next = getNextOpenSlot();
    hoursEl.textContent = next ? `¬∑ Ouvre ${next.jour} ${next.h}h${next.m ? String(next.m).padStart(2,'0') : '00'}` : '';
  }
  return open;
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', init);

async function init() {
  generateTimeSlots();
  const open = updateOpenStatus();
  setInterval(updateOpenStatus, 60000);
  if (sb) {
    await loadFromSupabase();
    subscribeRealtime();
  } else {
    categories = DEMO_CATEGORIES;
    menuItems = DEMO_ITEMS;
  }
  renderMenu();
  renderNavCats();
  updateCartUI();
  setupScrollSpy();
  setupScrollReveal();
  updateTimingBar();
  loadClientInfo();
}

// ===== SUPABASE =====
async function loadFromSupabase() {
  try {
    const [catRes, itemRes, ingRes] = await Promise.all([
      sb.from('menu_categories').select('*').order('ordre'),
      sb.from('menu_items').select('*').eq('actif', true).order('id'),
      sb.from('ingredients').select('*'),
    ]);
    if (catRes.data && catRes.data.length && itemRes.data && itemRes.data.length) {
      categories = catRes.data;
      menuItems = itemRes.data;
      if (ingRes.data) ingredients = ingRes.data;
      applyIngredientAvailability();
    } else {
      throw new Error('Donn√©es incompl√®tes');
    }
  } catch (e) {
    console.error('Erreur chargement:', e);
    categories = DEMO_CATEGORIES;
    menuItems = DEMO_ITEMS;
  }
}

function applyIngredientAvailability() {
  const unavailable = new Set(ingredients.filter(i => !i.disponible).map(i => i.nom.toLowerCase()));
  menuItems.forEach(item => {
    if (item.ingredients && Array.isArray(item.ingredients)) {
      if (item.ingredients.some(ing => unavailable.has(ing.toLowerCase()))) item.disponible = false;
    }
  });
}

function subscribeRealtime() {
  sb.channel('menu-changes')
    .on('postgres_changes', {event:'*', schema:'public', table:'ingredients'}, () => loadFromSupabase().then(renderMenu))
    .on('postgres_changes', {event:'*', schema:'public', table:'menu_items'}, () => loadFromSupabase().then(renderMenu))
    .subscribe();
}

// ===== TOAST NOTIFICATIONS =====
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  const icons = {
    error: '‚ùå',
    success: '‚úÖ',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };

  toast.innerHTML = `
    <span class="toast-icon">${icons[type] || icons.info}</span>
    <span class="toast-message">${message}</span>
  `;

  container.appendChild(toast);

  // Animation d'entr√©e
  setTimeout(() => toast.classList.add('show'), 10);

  // Animation de sortie et suppression
  setTimeout(() => {
    toast.classList.add('hide');
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 400);
  }, 3500);
}

// ===== RENDER =====
function renderMenu() {
  const container = document.getElementById('menuContent');
  let html = '';
  categories.forEach(cat => {
    const items = menuItems.filter(i => i.categorie_id === cat.id);
    if (!items.length) return;
    html += `<h2 class="menu-cat-title" id="cat-${cat.id}">${cat.emoji || ''} ${cat.nom}</h2>`;
    html += '<div class="menu-grid">';
    items.forEach(item => {
      const qty = getCartQty(item.id);
      html += `
        <div class="menu-card ${!item.disponible ? 'menu-card-unavailable' : ''}" data-id="${item.id}" onclick="${item.disponible ? `addToCart(${item.id})` : ''}">
          <div class="menu-card-visual">
            ${item.image_url
              ? `<img src="${item.image_url}?v=${IMAGE_VERSION}" alt="${item.nom}" loading="lazy">`
              : `<span class="emoji-placeholder">${item.emoji || 'üçΩÔ∏è'}</span>`
            }
          </div>
          ${qty > 0 ? `
          <div class="menu-card-stepper">
            <button onclick="event.stopPropagation();changeQty(${item.id},-1)">&minus;</button>
            <span>${qty}</span>
            <button onclick="event.stopPropagation();addToCart(${item.id})">+</button>
          </div>` : `
          <button class="menu-card-add"
                  onclick="event.stopPropagation();addToCart(${item.id})"
                  ${!item.disponible ? 'disabled' : ''}>+</button>`}
          <div class="menu-card-body">
            <div class="menu-card-name">${item.nom}</div>
            <div class="menu-card-desc">${item.description || ''}</div>
            <div class="menu-card-bottom">
              <span class="menu-card-price">${formatPrice(item.prix)}</span>
            </div>
          </div>
        </div>`;
    });
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderNavCats() {
  const nav = document.getElementById('navCats');
  nav.innerHTML = categories.map(cat =>
    `<button class="nav-cat" data-cat="${cat.id}" onclick="scrollToCat(${cat.id})">${cat.nom}</button>`
  ).join('');
}

// ===== CART =====
function getCartQty(id) { const c = cart.find(c => c.id === id); return c ? c.qty : 0; }

function addToCart(itemId) {
  const item = menuItems.find(i => i.id === itemId);
  if (!item || !item.disponible) return;

  // Si c'est une formule, ouvrir le modal de personnalisation
  if (FORMULE_CONFIG[item.nom]) {
    openFormuleModal(item);
    return;
  }

  const existing = cart.find(c => c.id === itemId);
  const isNew = !existing;
  if (existing) { existing.qty++; } else {
    cart.push({
      id: item.id,
      nom: item.nom,
      prix: item.prix,
      emoji: item.emoji || 'üçΩÔ∏è',
      image_url: item.image_url || null,
      qty: 1
    });
  }
  saveCart(); updateCartUI(); renderMenu();
  if (isNew) showUpsellBubble(itemId);
}

// ===== FORMULE CUSTOMIZER =====
let currentFormule = null;
let formuleSelections = {};

function openFormuleModal(formuleItem) {
  currentFormule = formuleItem;
  formuleSelections = {};
  const config = FORMULE_CONFIG[formuleItem.nom];
  document.getElementById('formuleTitle').textContent = formuleItem.nom;
  const container = document.getElementById('formuleComponents');
  container.innerHTML = config.map((comp, idx) => {
    let options = comp.category
      ? menuItems.filter(it => it.categorie_id === comp.category && it.disponible)
      : comp.items.map(name => ({ nom: name, image_url: ITEM_IMAGES[name] || null, emoji: 'üçΩÔ∏è' }));

    // Formule 3 : exclure certains desserts (garder Baklawas 3 pi√®ces)
    if (formuleItem.nom === 'Formule 3' && comp.category === 6) {
      options = options.filter(it =>
        !['Duo Sabl√©s', 'Assortiment Baklawas 250g', 'Assortiment Baklawas 500g'].includes(it.nom)
      );
    }
    return `
      <div class="formule-component">
        <div class="formule-component-title">
          ${comp.name}
          <span id="formuleCounter${idx}" style="font-size:.75rem;color:var(--text-muted);font-weight:400;margin-left:6px;">0/${comp.qty}</span>
        </div>
        <div class="formule-options" id="formuleComp${idx}">
          ${options.map((opt, optIdx) => {
            let imgClass = '';
            if (comp.category === 1) imgClass = 'sandwich-img';
            else if (comp.category === 7) imgClass = 'boisson-img';
            else if (comp.category === 6) imgClass = 'dessert-img';
            return `
            <div class="formule-option" onclick="selectFormuleOption(${idx}, ${optIdx}, ${comp.qty})">
              ${opt.image_url ? `<img src="${opt.image_url}" alt="${opt.nom}" class="${imgClass}">` : `<span style="font-size:1.2rem">${opt.emoji || 'üçΩÔ∏è'}</span>`}
              <div class="formule-option-info">
                <div class="formule-option-name">${opt.nom}</div>
              </div>
            </div>
          `;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');
  document.getElementById('formuleOverlay').classList.add('open');
  document.getElementById('formuleSheet').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeFormuleModal() {
  document.getElementById('formuleOverlay').classList.remove('open');
  document.getElementById('formuleSheet').classList.remove('open');
  document.body.style.overflow = '';
  currentFormule = null;
  formuleSelections = {};
}

function selectFormuleOption(compIdx, optIdx, maxQty) {
  const config = FORMULE_CONFIG[currentFormule.nom];
  const comp = config[compIdx];
  let options = comp.category
    ? menuItems.filter(it => it.categorie_id === comp.category && it.disponible)
    : comp.items.map(name => ({ nom: name }));

  // Formule 3 : exclure certains desserts (garder Baklawas 3 pi√®ces)
  if (currentFormule.nom === 'Formule 3' && comp.category === 6) {
    options = options.filter(it =>
      !['Duo Sabl√©s', 'Assortiment Baklawas 250g', 'Assortiment Baklawas 500g'].includes(it.nom)
    );
  }

  const selectedOpt = options[optIdx];

  if (!formuleSelections[compIdx]) formuleSelections[compIdx] = [];
  const selections = formuleSelections[compIdx];

  if (maxQty === 1) {
    // Max 1 : toggle ou remplace
    const existingIdx = selections.findIndex(s => s.nom === selectedOpt.nom);
    if (existingIdx >= 0) {
      selections.splice(existingIdx, 1);
    } else {
      selections[0] = selectedOpt;
    }
  } else {
    // Max > 1 : permet doublons + clic retire la derni√®re occurrence
    const count = selections.filter(s => s.nom === selectedOpt.nom).length;

    if (count >= maxQty || (count > 0 && selections.length >= maxQty)) {
      // Au max pour cet item OU plus de place ‚Üí retirer derni√®re occurrence
      const lastIdx = selections.map(s => s.nom).lastIndexOf(selectedOpt.nom);
      selections.splice(lastIdx, 1);
    } else if (selections.length < maxQty) {
      // Place disponible ‚Üí ajouter
      selections.push(selectedOpt);
    } else {
      // Plus de place ET item PAS s√©lectionn√© ‚Üí remplacer le dernier
      selections.pop();
      selections.push(selectedOpt);
    }
  }

  // Update UI
  const container = document.getElementById(`formuleComp${compIdx}`);
  Array.from(container.children).forEach((el, i) => {
    const count = selections.filter(s => s.nom === options[i].nom).length;
    el.classList.toggle('selected', count > 0);

    // Badge √óN si s√©lectionn√© plusieurs fois
    const existing = el.querySelector('.qty-badge');
    if (count > 1) {
      if (!existing) {
        const badge = document.createElement('span');
        badge.className = 'qty-badge';
        badge.textContent = `√ó${count}`;
        el.appendChild(badge);
      } else {
        existing.textContent = `√ó${count}`;
      }
    } else if (existing) {
      existing.remove();
    }
  });

  // Update counter
  const counter = document.getElementById(`formuleCounter${compIdx}`);
  const isComplete = selections.length === maxQty;
  counter.textContent = isComplete ? `${selections.length}/${maxQty} ‚úì` : `${selections.length}/${maxQty}`;
  counter.style.color = isComplete ? 'var(--green)' : 'var(--text-muted)';

  // Enable/disable add button
  const allSelected = config.every((c, i) => formuleSelections[i] && formuleSelections[i].length === c.qty);
  document.getElementById('formuleAddBtn').disabled = !allSelected;
}

function addFormuleToCart() {
  if (!currentFormule) return;
  const config = FORMULE_CONFIG[currentFormule.nom];
  const components = config.map((c, i) => formuleSelections[i] || []).flat();

  cart.push({
    id: currentFormule.id,
    nom: currentFormule.nom,
    prix: currentFormule.prix,
    emoji: currentFormule.emoji || 'üçΩÔ∏è',
    image_url: currentFormule.image_url || null,
    qty: 1,
    isFormule: true,
    components: components.map(c => c.nom)
  });

  saveCart();
  updateCartUI();
  renderMenu();
  closeFormuleModal();
  showToast('Formule ajout√©e au panier !', 'success');
}

function changeQty(itemId, delta) {
  const item = cart.find(c => c.id === itemId);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(c => c.id !== itemId);
  saveCart(); updateCartUI(); renderMenu();
}

function updateCartUI() {
  const total = cart.reduce((s, c) => s + c.prix * c.qty, 0);
  const count = cart.reduce((s, c) => s + c.qty, 0);
  const bar = document.getElementById('bottomBar');
  bar.classList.toggle('show', count > 0);
  document.getElementById('bottomCount').textContent = count;
  document.getElementById('bottomTotal').textContent = formatPrice(total);
  const itemsEl = document.getElementById('cartItems');
  const emptyEl = document.getElementById('cartEmpty');
  const footerEl = document.getElementById('cartFooter');
  const totalEl = document.getElementById('cartTotal');
  const suggestEl = document.getElementById('cartSuggest');
  if (cart.length === 0) {
    emptyEl.style.display = '';
    footerEl.style.display = 'none';
    suggestEl.style.display = 'none';
    itemsEl.querySelectorAll('.cart-item').forEach(el => el.remove());
    return;
  }
  emptyEl.style.display = 'none';
  footerEl.style.display = '';
  totalEl.textContent = formatPrice(total);

  // Initialiser l'heure si pas encore s√©lectionn√©e : toujours proposer le cr√©neau le plus proche
  if (!selectedPickup) {
    if (isOpenNow()) {
      // Si ouvert : cr√©neau ASAP (dans ~15 min)
      selectedPickup = 'asap';
      const asapTime = getAsapTime();
      document.getElementById('timingPickLabel').textContent = `Aujourd'hui ${asapTime}`;
      document.getElementById('cartPickupDisplay').innerHTML = `Aujourd'hui ${asapTime}<br><span style="font-size:.85rem;opacity:.8;">Cr√©neau le plus proche</span>`;
      document.getElementById('pickupTime').value = 'asap';
    } else {
      // Si ferm√© : prochaine ouverture
      const next = getNextOpenSlot();
      if (next) {
        const nextSlot = `${next.jour} ${next.h}h${next.m ? String(next.m).padStart(2,'0') : '00'}`;
        selectedPickup = nextSlot;
        document.getElementById('timingPickLabel').textContent = nextSlot;
        document.getElementById('cartPickupDisplay').innerHTML = `${nextSlot}<br><span style="font-size:.85rem;opacity:.8;">Cr√©neau le plus proche</span>`;
        document.getElementById('pickupTime').value = nextSlot;
      } else {
        document.getElementById('timingPickLabel').textContent = 'Choisir un cr√©neau';
        document.getElementById('cartPickupDisplay').textContent = 'Choisir un cr√©neau';
      }
    }
  }
  const existing = itemsEl.querySelectorAll('.cart-item');
  existing.forEach(el => el.remove());
  cart.forEach(c => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    const visual = c.image_url
      ? `<img src="${c.image_url}" alt="${c.nom}" style="width:40px;height:40px;object-fit:cover;border-radius:10px;">`
      : `<div class="cart-item-emoji">${c.emoji}</div>`;

    // Si c'est une formule, afficher les composants
    const componentsHtml = c.isFormule && c.components
      ? `<div style="font-size:.7rem;color:var(--text-soft);margin-top:2px;">‚Üí ${c.components.join(', ')}</div>`
      : '';

    div.innerHTML = `
      ${visual}
      <div class="cart-item-info">
        <div class="cart-item-name">${c.nom}</div>
        <div class="cart-item-price">${formatPrice(c.prix)} chacun</div>
        ${componentsHtml}
      </div>
      <div class="cart-item-qty">
        <button onclick="changeQty(${c.id},-1)">&minus;</button>
        <span>${c.qty}</span>
        <button onclick="changeQty(${c.id},1)">+</button>
      </div>`;
    itemsEl.appendChild(div);
  });
  renderSuggestions();
}

function renderSuggestions() {
  const suggestEl = document.getElementById('cartSuggest');
  const listEl = document.getElementById('cartSuggestList');
  const cartIds = new Set(cart.map(c => c.id));

  // Build set of categories pr√©sentes dans le panier (y compris dans les formules)
  const cartCatIds = new Set(cart.map(c => {
    const item = menuItems.find(i => i.id === c.id);
    return item ? item.categorie_id : 0;
  }));

  // Pour les formules, ajouter les cat√©gories de leurs composants
  cart.forEach(c => {
    if (c.isFormule) {
      const item = menuItems.find(i => i.id === c.id);
      if (item && FORMULE_CONFIG[item.nom]) {
        FORMULE_CONFIG[item.nom].forEach(comp => {
          if (comp.category) {
            cartCatIds.add(comp.category); // Ajouter la cat√©gorie du composant (ex: 7 pour Boisson)
          }
        });
      }
    }
  });

  let suggestions = [];
  if ((cartCatIds.has(1) || cartCatIds.has(3) || cartCatIds.has(4)) && !cartCatIds.has(7)) {
    suggestions.push(...menuItems.filter(i => i.categorie_id === 7 && i.disponible && !cartIds.has(i.id)).slice(0, 3));
  }
  if ((cartCatIds.has(1) || cartCatIds.has(2) || cartCatIds.has(3) || cartCatIds.has(4)) && !cartCatIds.has(6)) {
    suggestions.push(...menuItems.filter(i => i.categorie_id === 6 && i.disponible && !cartIds.has(i.id)).slice(0, 3));
  }
  if ((cartCatIds.has(1) || cartCatIds.has(3)) && !cartCatIds.has(13)) {
    suggestions.push(...menuItems.filter(i => i.categorie_id === 13 && i.disponible && !cartIds.has(i.id)).slice(0, 2));
  }
  suggestions = [...new Map(suggestions.map(s => [s.id, s])).values()].slice(0, 6);
  if (suggestions.length === 0 || cart.length === 0) {
    suggestEl.style.display = 'none';
    return;
  }
  const titleEl = suggestEl.querySelector('.cart-suggest-title');
  if (!cartCatIds.has(7)) titleEl.textContent = 'Une boisson avec √ßa ?';
  else if (!cartCatIds.has(6)) titleEl.textContent = 'Un dessert pour finir ?';
  else titleEl.textContent = 'Vous aimerez aussi';
  suggestEl.style.display = '';
  listEl.innerHTML = suggestions.map(s => {
    const visual = s.image_url
      ? `<img src="${s.image_url}" alt="${s.nom}" style="width:32px;height:32px;object-fit:cover;border-radius:6px;" class="suggest-emoji">`
      : `<span class="suggest-emoji">${s.emoji || 'üçΩÔ∏è'}</span>`;
    return `
      <div class="cart-suggest-item" onclick="addToCart(${s.id});updateCartUI();renderMenu()">
        ${visual}
        <div>
          <div class="suggest-name">${s.nom}</div>
          <div class="suggest-price">${formatPrice(s.prix)}</div>
        </div>
        <span class="suggest-add">+</span>
      </div>
    `;
  }).join('');
}

// ===== UPSELL =====
let upsellTimeout = null;
let pendingUpsell = null;

function getSmartUpsell(addedItem) {
  const item = menuItems.find(i => i.id === addedItem);
  if (!item) return null;
  const cartCatIds = new Set(cart.map(c => {
    const mi = menuItems.find(i => i.id === c.id);
    return mi ? mi.categorie_id : 0;
  }));
  if (item.categorie_id === 1 && !cartCatIds.has(2)) {
    const formule1 = menuItems.find(i => i.id === 10 && i.disponible);
    if (formule1) {
      return {
        emoji: 'üí°',
        text: `<strong>Formule 1 √† ${formatPrice(formule1.prix)}</strong> ‚Äî sandwich + 2 feuillet√©s + boisson`,
        action: () => { cart = cart.filter(c => c.id !== addedItem); addToCart(formule1.id); },
        btn: 'Passer en formule'
      };
    }
  }
  if (item.categorie_id === 2 && !cartCatIds.has(6)) {
    const desserts = menuItems.filter(i => i.categorie_id === 6 && i.disponible);
    if (desserts.length) {
      const d = desserts[Math.floor(Math.random() * desserts.length)];
      return {
        emoji: 'üçÆ',
        text: `Finissez en douceur ! <strong>${d.nom}</strong> ‚Äî ${formatPrice(d.prix)}`,
        action: () => addToCart(d.id),
        btn: `+ ${formatPrice(d.prix)}`
      };
    }
  }
  if ([3, 4].includes(item.categorie_id) && !cartCatIds.has(7)) {
    return {
      emoji: 'ü•§',
      text: 'Une <strong>boisson fra√Æche</strong> avec votre plat ? √Ä partir de <strong>2,00 ‚Ç¨</strong>',
      action: () => scrollToCat(7),
      btn: 'Voir les boissons'
    };
  }
  if (item.categorie_id === 6 && !cartCatIds.has(7)) {
    const ayran = menuItems.find(i => i.nom === 'Ayran' && i.disponible);
    if (ayran) {
      return {
        emoji: 'ü•õ',
        text: `Accompagnez avec un <strong>Ayran</strong> ‚Äî yaourt sal√© rafra√Æchissant ${formatPrice(ayran.prix)}`,
        action: () => addToCart(ayran.id),
        btn: `+ ${formatPrice(ayran.prix)}`
      };
    }
  }
  return null;
}

function showUpsellBubble(addedItemId) {
  const upsell = getSmartUpsell(addedItemId);
  if (!upsell) return;
  pendingUpsell = upsell;
  document.getElementById('upsellEmoji').textContent = upsell.emoji;
  document.getElementById('upsellText').innerHTML = upsell.text;
  document.getElementById('upsellBtn').textContent = upsell.btn;
  const bubble = document.getElementById('upsellBubble');
  bubble.classList.add('show');
  clearTimeout(upsellTimeout);
  upsellTimeout = setTimeout(dismissUpsell, 6000);
}

function applyUpsell() {
  if (pendingUpsell) { pendingUpsell.action(); saveCart(); updateCartUI(); renderMenu(); }
  dismissUpsell();
}

function dismissUpsell() {
  document.getElementById('upsellBubble').classList.remove('show');
  clearTimeout(upsellTimeout);
  pendingUpsell = null;
}

function toggleCart() {
  document.getElementById('cartOverlay').classList.toggle('open');
  document.getElementById('cartPanel').classList.toggle('open');
  document.body.style.overflow = document.getElementById('cartPanel').classList.contains('open') ? 'hidden' : '';
}

function saveCart() { localStorage.setItem('be_cart', JSON.stringify(cart)); }

// ===== CLIENT MEMORY =====
function saveClientInfo() {
  const info = {
    prenom: document.getElementById('clientName').value.trim(),
    email: document.getElementById('clientEmail').value.trim(),
    telephone: document.getElementById('clientPhone').value.trim(),
  };
  if (info.prenom || info.email) localStorage.setItem('be_client', JSON.stringify(info));
}

function loadClientInfo() {
  try {
    const info = JSON.parse(localStorage.getItem('be_client'));
    if (!info) return;
    if (info.prenom) document.getElementById('clientName').value = info.prenom;
    if (info.email) document.getElementById('clientEmail').value = info.email;
    if (info.telephone) document.getElementById('clientPhone').value = info.telephone;
  } catch(e) {}
}

function generateTimeSlots() {}

// ===== ORDER =====
async function submitOrder() {
  const name = document.getElementById('clientName').value.trim();
  const email = document.getElementById('clientEmail').value.trim();
  const phone = document.getElementById('clientPhone').value.trim();
  const pickup = document.getElementById('pickupTime').value;
  if (!name) { showToast('Entrez votre pr√©nom', 'error'); return; }
  if (!phone) { showToast('Entrez votre t√©l√©phone', 'error'); return; }
  if (!email || !email.includes('@')) { showToast('Entrez un email valide', 'error'); return; }
  if (!pickup) { showToast('Choisissez une heure de retrait', 'error'); return; }
  // V√©rifier que ASAP n'est pas choisi quand le restaurant est ferm√© (ne devrait plus arriver)
  if (pickup === 'asap' && !isOpenNow()) {
    showToast('Le restaurant est ferm√©. Choisissez un autre cr√©neau.', 'error');
    return;
  }
  if (!cart.length) return;
  const btn = document.getElementById('cartSubmit');
  btn.disabled = true; btn.textContent = 'Redirection paiement...';
  saveClientInfo();
  const total = cart.reduce((s, c) => s + c.prix * c.qty, 0);
  const orderNum = 'BE-' + String(Math.floor(Math.random()*9000)+1000);
  const note = document.getElementById('clientNote').value.trim();
  const optin = document.getElementById('optinPromos').checked;

  // Cr√©er la commande en statut "pending"
  const orderData = {
    numero: orderNum,
    items: cart.map(c => ({
      id: c.id,
      nom: c.nom,
      prix: c.prix,
      qty: c.qty,
      image_url: c.image_url || null,
      isFormule: c.isFormule || false,
      components: c.components || null
    })),
    total: Math.round(total*100)/100,
    statut: 'pending',
    heure_retrait: pickup,
    client_prenom: name, client_email: email,
    client_telephone: phone || null,
    note: note || null,
    created_at: new Date().toISOString(),
  };

  try {
    // Enregistrer le client
    let codeRetrait = null;
    if (sb) {
      await sb.from('clients').upsert({
        email, prenom: name, telephone: phone || null,
        derniere_commande: new Date().toISOString(),
        optin_promo: optin,
      }, {onConflict: 'email'});

      // Ins√©rer la commande et r√©cup√©rer le code_retrait g√©n√©r√©
      const {data: insertData, error: insertError} = await sb.from('orders')
        .insert([orderData])
        .select('code_retrait')
        .single();

      if (insertError) throw insertError;
      codeRetrait = insertData?.code_retrait;
    }

    btn.textContent = 'Ouverture du paiement...';

    // Appeler l'Edge Function pour cr√©er la session Paygreen
    const {data, error} = await sb.functions.invoke('create-payment', {
      body: {orderNum, total: Math.round(total * 100), email, name, phone, pickup, note, items: cart}
    });

    if (error) {
      console.error('Edge Function error:', error);
      console.error('Edge Function data:', data);
      throw new Error(data?.error || error.message || 'Erreur de paiement');
    }

    // Ouvrir le paiement dans un modal (mode embedded)
    if (data.paymentUrl) {
      openPaymentModal(data.paymentUrl, orderNum, codeRetrait);
    } else {
      throw new Error('URL de paiement non re√ßue');
    }
  } catch (e) {
    console.error('Erreur:', e);
    showToast(`Erreur lors du paiement: ${e.message || 'R√©essayez'}`, 'error');
    btn.disabled = false;
    btn.textContent = 'Passer la commande';
    if (sb) await sb.from('orders').delete().eq('numero', orderNum);
  }
}

// ===== PAYMENT MODAL =====
function openPaymentModal(paymentUrl, orderNum, codeRetrait) {
  const modal = document.createElement('div');
  modal.id = 'paymentModal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';

  const container = document.createElement('div');
  container.style.cssText = 'background:#fff;border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);';

  const header = document.createElement('div');
  header.style.cssText = 'padding:20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;';
  header.innerHTML = '<h3 style="margin:0;font-size:1.1rem;font-weight:700;">Paiement s√©curis√©</h3><button onclick="closePaymentModal()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:#999;">&times;</button>';

  const iframe = document.createElement('iframe');
  iframe.src = paymentUrl;
  iframe.style.cssText = 'width:100%;height:600px;border:none;';
  iframe.onload = () => {
    document.getElementById('cartSubmit').disabled = false;
    document.getElementById('cartSubmit').textContent = 'Passer la commande';
  };

  // √âcouter les messages du paiement (succ√®s/√©chec)
  window.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'payment') {
      if (event.data.status === 'success') {
        closePaymentModal();
        toggleCart();
        showConfirmation(orderNum, codeRetrait);
      } else if (event.data.status === 'cancel') {
        closePaymentModal();
        showToast('Paiement annul√©', 'warning');
      }
    }
  });

  container.appendChild(header);
  container.appendChild(iframe);
  modal.appendChild(container);
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

function closePaymentModal() {
  const modal = document.getElementById('paymentModal');
  if (modal) {
    modal.remove();
    document.body.style.overflow = '';
  }
}

async function showConfirmation(orderNum, codeRetrait) {
  toggleCart();
  document.getElementById('confirmOrderNum').textContent = orderNum;
  if (codeRetrait) {
    document.getElementById('confirmCode').textContent = codeRetrait;
    document.getElementById('confirmCode').style.display = 'block';
  }
  document.getElementById('confirmTrackBtn').href = `commande.html?num=${orderNum}`;
  document.getElementById('confirmModal').classList.add('open');

  // Envoyer le re√ßu par email si demand√©
  const wantReceipt = document.getElementById('wantReceipt').checked;
  if (wantReceipt && sb) {
    const email = document.getElementById('clientEmail').value.trim();
    const name = document.getElementById('clientName').value.trim();
    const pickup = document.getElementById('pickupTime').value;
    const total = cart.reduce((s, c) => s + c.prix * c.qty, 0);

    try {
      await sb.functions.invoke('send-receipt', {
        body: { email, name, orderNum, codeRetrait, items: cart, total, pickup }
      });
    } catch (e) {
      console.error('Erreur envoi re√ßu:', e);
      // Ne pas bloquer si l'email √©choue
    }
  }

  cart = []; saveCart(); updateCartUI(); renderMenu();
  document.getElementById('cartSubmit').disabled = false;
  document.getElementById('cartSubmit').textContent = 'Passer la commande';
  ['clientNote'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('wantReceipt').checked = true; // Reset √† checked par d√©faut
  document.getElementById('optinPromos').checked = true; // Optin promos par d√©faut
}

// ===== NAV =====
function scrollToCat(catId) {
  const el = document.getElementById('cat-' + catId);
  if (el) {
    const navH = document.getElementById('nav').offsetHeight;
    window.scrollTo({top: el.offsetTop - navH - 8, behavior:'smooth'});
  }
  document.querySelectorAll('.nav-cat').forEach(b => b.classList.toggle('active', +b.dataset.cat === catId));
}

function setupScrollSpy() {
  const nav = document.getElementById('nav');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const id = e.target.id.replace('cat-','');
        document.querySelectorAll('.nav-cat').forEach(b => b.classList.toggle('active', b.dataset.cat === id));
        const active = document.querySelector('.nav-cat.active');
        if (active) active.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
      }
    });
  }, {rootMargin: `-${nav.offsetHeight + 20}px 0px -70% 0px`, threshold:0});
  categories.forEach(cat => {
    const el = document.getElementById('cat-' + cat.id);
    if (el) observer.observe(el);
  });
}

// ===== TIMING =====
let selectedPickup = 'asap';

function updateTimingBar() {
  const open = isOpenNow();
  const dot = document.getElementById('timingDot');
  const text = document.getElementById('timingText');
  if (open) {
    if (dot) dot.classList.remove('closed');
    const now = new Date();
    const slot = BUSINESS_HOURS.find(s => s[0] === now.getDay());
    if (text) text.innerHTML = `Ouvert <small>¬∑ Ferme √† ${slot[3]}h${slot[4] ? String(slot[4]).padStart(2,'0') : '00'}</small>`;
  } else {
    if (dot) dot.classList.add('closed');
    const next = getNextOpenSlot();
    if (text) text.innerHTML = next ? `Ferm√© <small>¬∑ Ouvre ${next.jour} ${next.h}h${next.m ? String(next.m).padStart(2,'0') : '00'}</small>` : 'Ferm√©';
    if (selectedPickup === 'asap') {
      selectedPickup = '';
      document.getElementById('timingPickLabel').textContent = 'Choisir un cr√©neau';
    }
  }
  document.getElementById('pickupTime').value = selectedPickup;
}

// ===== TIME PICKER =====
let tpDays = [];
let tpSelectedDay = 0;

function openTimePicker() {
  buildTimePicker();
  document.getElementById('tpOverlay').classList.add('open');
  document.getElementById('tpSheet').classList.add('open');
}

function closeTimePicker() {
  document.getElementById('tpOverlay').classList.remove('open');
  document.getElementById('tpSheet').classList.remove('open');
}

function buildTimePicker() {
  const now = new Date();
  const open = isOpenNow();
  const asapBtn = document.getElementById('tpAsap');

  // Toujours proposer le cr√©neau le plus proche (ouvert ou ferm√©)
  if (open) {
    // Si ouvert : proposer dans 15 min
    const asapTime = getAsapTime();
    const slot = `Aujourd'hui ${asapTime}`;
    asapBtn.disabled = false;
    asapBtn.onclick = () => selectTime('asap');
    asapBtn.innerHTML = `Cr√©neau le plus proche<span class="timepicker-asap-sub">${slot}</span>`;
  } else {
    // Si ferm√© : proposer la prochaine ouverture
    const next = getNextOpenSlot();
    if (next) {
      asapBtn.disabled = false;
      const nextSlot = `${next.jour} ${next.h}h${next.m ? String(next.m).padStart(2,'0') : '00'}`;
      asapBtn.onclick = () => selectTime(nextSlot);
      asapBtn.innerHTML = `Cr√©neau le plus proche<span class="timepicker-asap-sub">${nextSlot}</span>`;
    } else {
      asapBtn.disabled = true;
      asapBtn.innerHTML = `Cr√©neau le plus proche<span class="timepicker-asap-sub">Indisponible</span>`;
    }
  }

  tpDays = [];
  for (let d = 0; d <= 7; d++) {
    const date = new Date(now);
    date.setDate(date.getDate() + d);
    const dayOfWeek = date.getDay();
    const slot = BUSINESS_HOURS.find(s => s[0] === dayOfWeek);
    if (!slot) continue;
    tpDays.push({
      date, dayOfWeek, slot, isToday: d === 0,
      label: d === 0 ? "Aujourd'hui" : d === 1 ? 'Demain' : JOURS[dayOfWeek],
      sub: `${date.getDate()}/${date.getMonth()+1}`
    });
    if (tpDays.length >= 2) break; // Seulement aujourd'hui + demain
  }
  const daysEl = document.getElementById('tpDays');
  daysEl.innerHTML = tpDays.map((day, i) => `
    <div class="timepicker-day ${i === tpSelectedDay ? 'active' : ''}" onclick="selectPickerDay(${i})">
      ${day.label}<small>${day.sub}</small>
    </div>
  `).join('');
  renderTimeSlots();
}

function selectPickerDay(idx) {
  tpSelectedDay = idx;
  document.querySelectorAll('.timepicker-day').forEach((el, i) => el.classList.toggle('active', i === idx));
  renderTimeSlots();
}

function renderTimeSlots() {
  const day = tpDays[tpSelectedDay];
  if (!day) return;
  const now = new Date();
  const slotsEl = document.getElementById('tpSlots');
  const startMin = day.slot[1] * 60 + day.slot[2];
  const endMin = day.slot[3] * 60 + day.slot[4];
  let html = '';
  let count = 0;
  for (let m = startMin; m <= endMin; m += 30) { // Cr√©neaux toutes les 30 min
    const h = Math.floor(m / 60), min = m % 60;
    const label = `${h}h${min.toString().padStart(2, '0')}`;
    const isPast = day.isToday && (now.getHours() * 60 + now.getMinutes()) >= m;
    if (isPast) continue; // Ne pas afficher les cr√©neaux pass√©s
    const value = day.isToday ? label : `${day.label} ${label}`;
    html += `<div class="timepicker-slot ${selectedPickup === value ? 'active' : ''}"
      onclick="selectTime('${value}')">${label}</div>`;
    count++;
    if (count >= 8) break; // Max 8 cr√©neaux affich√©s
  }
  slotsEl.innerHTML = html;
}

// Calcule l'heure ASAP (maintenant + 20 min, arrondi au prochain quart d'heure)
function getAsapTime() {
  const now = new Date();
  now.setMinutes(now.getMinutes() + 20);
  // Arrondir au prochain quart d'heure
  const minutes = now.getMinutes();
  const rounded = Math.ceil(minutes / 15) * 15;
  now.setMinutes(rounded);
  const h = now.getHours();
  const m = now.getMinutes();
  return `${h}h${m.toString().padStart(2, '0')}`;
}

function selectTime(value) {
  selectedPickup = value;
  document.getElementById('pickupTime').value = value;

  // Afficher l'heure dans la barre du haut
  let topLabel, cartLabel;
  if (value === 'asap') {
    const asapTime = getAsapTime();
    topLabel = `Aujourd'hui ${asapTime}`;
    cartLabel = `Aujourd'hui ${asapTime}<br><span style="font-size:.85rem;opacity:.8;">Cr√©neau le plus proche</span>`;
  } else {
    topLabel = value;
    cartLabel = value;
  }

  document.getElementById('timingPickLabel').textContent = topLabel;
  document.getElementById('cartPickupDisplay').innerHTML = cartLabel;
  closeTimePicker();
}

// ===== UTILS =====
function formatPrice(n) { return n.toFixed(2).replace('.', ',') + ' ‚Ç¨'; }

// ===== SCROLL REVEAL =====
let revealDone = false;
function setupScrollReveal() {
  if (revealDone) return;
  revealDone = true;
  document.querySelectorAll('.menu-card').forEach(card => card.classList.add('reveal'));
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        const card = entry.target;
        const siblings = [...card.parentElement.children];
        const idx = siblings.indexOf(card);
        setTimeout(() => card.classList.add('visible'), idx * 60);
        observer.unobserve(card);
      }
    });
  }, {threshold: 0.1, rootMargin: '0px 0px -40px 0px'});
  document.querySelectorAll('.menu-card.reveal').forEach(card => observer.observe(card));
}

document.getElementById('confirmModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('open');
});
</script>
</body>
</html>
