<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Beyrouth Express ‚Äî Click & Collect | A Beyrouth, La D√©fense</title>
<meta name="description" content="Commandez en ligne chez A Beyrouth √† La D√©fense. Cuisine libanaise traditionnelle, retrait express sans faire la queue.">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßÜ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --green:#06C167;--green-dark:#05a559;
  --noir:#191919;--gris:#545454;--gris-light:#EEEEEE;
  --blanc:#FFFFFF;--bg:#FAFAFA;
  --shadow:0 2px 8px rgba(0,0,0,.08);--shadow-lg:0 4px 16px rgba(0,0,0,.12);
  --radius:12px;--radius-sm:8px;
}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,sans-serif;color:var(--noir);background:var(--bg);line-height:1.5;overflow-x:hidden;padding-bottom:0}
button{cursor:pointer;font-family:inherit;border:none;outline:none}
img{max-width:100%;display:block}
a{color:inherit;text-decoration:none}

/* ========= HEADER COMPACT ========= */
.header{
  background:var(--noir);color:#fff;padding:16px 24px;
}
.header-inner{max-width:1000px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.header-left h1{font-size:1.4rem;font-weight:800;letter-spacing:-.5px}
.header-left h1 span{color:var(--green)}
.header-left p{font-size:.8rem;opacity:.6;margin-top:2px}
.header-right{display:flex;align-items:center;gap:8px}
.header-status{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.1);padding:6px 12px;border-radius:20px;font-size:.75rem;
}
.header-status .dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0}

/* ========= TIMING PICKER ========= */
.timing-bar{
  background:var(--blanc);border-bottom:1px solid var(--gris-light);
}
.timing-inner{
  max-width:1000px;margin:0 auto;padding:10px 24px;
  display:flex;align-items:center;gap:8px;
}
.timing-tagline{font-size:.8rem;color:var(--gris);margin-right:auto;font-weight:500}
.timing-btn{
  padding:8px 18px;border-radius:20px;font-size:.82rem;font-weight:600;
  transition:all .2s;background:var(--gris-light);color:var(--noir);
}
.timing-btn.active{background:var(--noir);color:#fff}
.timing-btn:hover:not(.active){background:#ddd}

/* ========= NAV CATEGORIES ========= */
.nav{
  position:sticky;top:0;z-index:100;background:var(--blanc);
  border-bottom:1px solid var(--gris-light);
}
.nav-inner{max-width:1000px;margin:0 auto;padding:0 24px;display:flex;align-items:center;gap:0;overflow-x:auto;scrollbar-width:none}
.nav-inner::-webkit-scrollbar{display:none}
.nav-cat{
  padding:14px 16px;font-size:.875rem;font-weight:500;
  white-space:nowrap;color:var(--gris);transition:all .2s;background:none;
  border-bottom:2px solid transparent;flex-shrink:0;
}
.nav-cat:hover{color:var(--noir)}
.nav-cat.active{color:var(--noir);font-weight:700;border-bottom-color:var(--noir)}

/* ========= MENU ========= */
.menu-section{max-width:1000px;margin:0 auto;padding:16px 24px 100px}
.menu-cat-title{
  font-size:1.35rem;font-weight:800;margin:24px 0 12px;padding-top:8px;
  letter-spacing:-.3px;
}
.menu-cat-title:first-child{margin-top:8px}

/* Items en lignes compactes style Uber Eats */
.menu-list{display:flex;flex-direction:column;gap:1px;background:var(--gris-light);border-radius:var(--radius);overflow:hidden;margin-bottom:8px}
.menu-item{
  display:flex;align-items:center;gap:12px;padding:14px 16px;
  background:var(--blanc);cursor:pointer;transition:background .15s;
}
.menu-item:hover{background:#f5f5f5}
.menu-item-info{flex:1;min-width:0}
.menu-item-name{font-weight:600;font-size:.95rem}
.menu-item-desc{font-size:.8rem;color:var(--gris);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.menu-item-price{font-weight:700;font-size:.95rem;flex-shrink:0}
.menu-item-img{
  width:72px;height:72px;border-radius:var(--radius-sm);overflow:hidden;flex-shrink:0;
  background:var(--gris-light);display:flex;align-items:center;justify-content:center;font-size:1.8rem;
}
.menu-item-img img{width:100%;height:100%;object-fit:cover}
.menu-item-add{
  width:32px;height:32px;border-radius:50%;background:var(--gris-light);
  font-size:1.2rem;display:flex;align-items:center;justify-content:center;
  transition:all .2s;font-weight:600;color:var(--noir);flex-shrink:0;
}
.menu-item-add:hover{background:var(--green);color:#fff}
.menu-item-add.in-cart{background:var(--green);color:#fff;font-size:.8rem}
.menu-item-unavailable{opacity:.5;pointer-events:none}
.menu-item-unavailable .menu-item-add{display:none}

/* ========= BOTTOM CART BAR (style Uber Eats) ========= */
.bottom-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:150;
  padding:12px 24px;background:var(--blanc);
  border-top:1px solid var(--gris-light);
  transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);
}
.bottom-bar.show{transform:translateY(0)}
.bottom-bar-inner{max-width:1000px;margin:0 auto}
.bottom-bar-btn{
  width:100%;padding:16px;background:var(--noir);color:#fff;
  border-radius:var(--radius-sm);font-size:1rem;font-weight:700;
  display:flex;align-items:center;justify-content:space-between;
  transition:background .2s;
}
.bottom-bar-btn:hover{background:#333}
.bottom-bar-count{
  background:rgba(255,255,255,.2);padding:2px 10px;border-radius:20px;font-size:.85rem;
}
.bottom-bar-total{font-size:1rem}

/* ========= CART PANEL ========= */
.cart-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;
  opacity:0;pointer-events:none;transition:opacity .3s;
}
.cart-overlay.open{opacity:1;pointer-events:auto}
.cart-panel{
  position:fixed;top:0;right:0;bottom:0;width:min(440px,100vw);
  background:var(--blanc);z-index:201;
  transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;
}
.cart-panel.open{transform:translateX(0)}

.cart-header{
  padding:20px 20px 16px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--gris-light);
}
.cart-header h3{font-size:1.15rem;font-weight:800}
.cart-close{background:var(--gris-light);width:32px;height:32px;border-radius:50%;font-size:1.2rem;display:flex;align-items:center;justify-content:center}

.cart-items{flex:1;overflow-y:auto;padding:12px 20px}
.cart-empty{text-align:center;padding:48px 20px;color:var(--gris);font-size:.9rem}
.cart-item{
  display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--gris-light);
  align-items:center;
}
.cart-item-emoji{font-size:1.5rem;width:36px;text-align:center;flex-shrink:0}
.cart-item-info{flex:1;min-width:0}
.cart-item-name{font-weight:600;font-size:.9rem}
.cart-item-price{font-size:.8rem;color:var(--gris);font-weight:500}
.cart-item-qty{display:flex;align-items:center;gap:6px;flex-shrink:0}
.cart-item-qty button{
  width:28px;height:28px;border-radius:50%;background:var(--gris-light);
  font-size:1rem;display:flex;align-items:center;justify-content:center;
  transition:background .2s;font-weight:600;
}
.cart-item-qty button:hover{background:#ddd}
.cart-item-qty span{font-weight:700;min-width:20px;text-align:center;font-size:.9rem}

/* ========= CHECKOUT ========= */
.cart-footer{padding:16px 20px;border-top:1px solid var(--gris-light);background:var(--blanc)}
.cart-subtotal{display:flex;justify-content:space-between;margin-bottom:12px;font-size:.9rem;color:var(--gris)}
.cart-subtotal strong{color:var(--noir);font-size:1.1rem}
.cart-form{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.cart-form input,.cart-form select{
  padding:12px 14px;border:1.5px solid var(--gris-light);border-radius:var(--radius-sm);
  font-size:.9rem;font-family:inherit;background:var(--blanc);
  transition:border-color .2s;
}
.cart-form input:focus,.cart-form select:focus{border-color:var(--noir);outline:none}
.cart-form .form-row{display:flex;gap:8px}
.cart-form .form-row>*{flex:1}
.cart-checkout-btn{
  width:100%;padding:16px;background:var(--green);color:#fff;
  border-radius:var(--radius-sm);font-size:1rem;font-weight:700;
  transition:background .2s;
}
.cart-checkout-btn:hover{background:var(--green-dark)}
.cart-checkout-btn:disabled{opacity:.4;cursor:not-allowed}
.cart-pay-info{font-size:.75rem;color:var(--gris);text-align:center;margin-top:6px}

/* ========= CONFIRMATION MODAL ========= */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;
  display:none;align-items:center;justify-content:center;padding:24px;
}
.modal-overlay.open{display:flex}
.modal{
  background:var(--blanc);border-radius:var(--radius);padding:32px;
  max-width:400px;width:100%;text-align:center;
  animation:modalIn .3s ease-out;
}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px)}to{opacity:1;transform:none}}
.modal-icon{font-size:3rem;margin-bottom:12px}
.modal h3{font-size:1.2rem;font-weight:800;margin-bottom:4px}
.modal-order-num{font-size:1.8rem;font-weight:800;color:var(--green);margin:8px 0}
.modal p{color:var(--gris);font-size:.9rem;margin-bottom:16px}
.modal-btn{
  display:inline-block;padding:12px 28px;background:var(--noir);
  color:#fff;border-radius:var(--radius-sm);font-weight:700;font-size:.9rem;transition:background .2s;
}
.modal-btn:hover{background:#333}

/* ========= FOOTER ========= */
.footer{background:var(--noir);color:#fff;padding:24px;text-align:center;font-size:.8rem;opacity:.6}

/* ========= RESPONSIVE ========= */
@media(max-width:640px){
  .header-inner{flex-direction:column;align-items:flex-start;gap:6px}
  .timing-inner{flex-wrap:wrap;gap:6px}
  .timing-tagline{width:100%;margin-right:0;font-size:.75rem}
  .timing-btn{padding:6px 14px;font-size:.78rem}
  .menu-item-desc{display:none}
  .menu-item-img{width:56px;height:56px}
  .menu-item{padding:10px 12px;gap:10px}
  .cart-panel{width:100vw}
  .cart-form .form-row{flex-direction:column;gap:8px}
}
</style>
</head>
<body>

<!-- ===== HEADER COMPACT ===== -->
<header class="header">
  <div class="header-inner">
    <div class="header-left">
      <h1>A Beyrouth <span>Express</span></h1>
      <p>Click & Collect ‚Äî Commande, on pr√©pare, tu r√©cup√®res</p>
    </div>
    <div class="header-right">
      <div class="header-status"><span class="dot"></span> Ouvert</div>
    </div>
  </div>
</header>

<!-- ===== TIMING PICKER ===== -->
<div class="timing-bar">
  <div class="timing-inner">
    <span class="timing-tagline">Retrait sur place - La D√©fense (Sortie 4 m√©tro)</span>
    <button class="timing-btn active" id="btnNow" onclick="setTiming('now')">J'ai faim maintenant</button>
    <button class="timing-btn" id="btnLater" onclick="setTiming('later')">Plus tard</button>
  </div>
</div>

<!-- ===== NAV CATEGORIES ===== -->
<nav class="nav" id="nav">
  <div class="nav-inner" id="navCats"></div>
</nav>

<!-- ===== MENU ===== -->
<section class="menu-section" id="menu">
  <div id="menuContent"></div>
</section>

<!-- ===== BOTTOM CART BAR ===== -->
<div class="bottom-bar" id="bottomBar">
  <div class="bottom-bar-inner">
    <button class="bottom-bar-btn" onclick="toggleCart()">
      <span>Voir le panier <span class="bottom-bar-count" id="bottomCount">0</span></span>
      <span class="bottom-bar-total" id="bottomTotal">0,00 ‚Ç¨</span>
    </button>
  </div>
</div>

<!-- ===== CART PANEL ===== -->
<div class="cart-overlay" id="cartOverlay" onclick="toggleCart()"></div>
<div class="cart-panel" id="cartPanel">
  <div class="cart-header">
    <h3>Votre commande</h3>
    <button class="cart-close" onclick="toggleCart()">&times;</button>
  </div>
  <div class="cart-items" id="cartItems">
    <div class="cart-empty" id="cartEmpty">Votre panier est vide</div>
  </div>
  <div class="cart-footer" id="cartFooter" style="display:none">
    <div class="cart-subtotal">
      <span>Total</span>
      <strong id="cartTotal">0,00 ‚Ç¨</strong>
    </div>
    <div class="cart-form">
      <select id="pickupTime">
        <option value="">Heure de retrait...</option>
        <option value="asap">D√®s que possible (~15 min)</option>
      </select>
      <input type="text" id="clientName" placeholder="Pr√©nom" required>
      <div class="form-row">
        <input type="tel" id="clientPhone" placeholder="T√©l√©phone" required>
        <input type="email" id="clientEmail" placeholder="Email" required>
      </div>
    </div>
    <button class="cart-checkout-btn" id="cartSubmit" onclick="submitOrder()">
      Passer la commande
    </button>
    <p class="cart-pay-info">Paiement sur place (CB, esp√®ces, carte resto)</p>
  </div>
</div>

<!-- ===== CONFIRMATION MODAL ===== -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <div class="modal-icon">&#10003;</div>
    <h3>Commande envoy√©e !</h3>
    <div class="modal-order-num" id="confirmOrderNum">BE-0001</div>
    <p id="confirmText">On pr√©pare votre commande.<br>Vous serez pr√©venu quand c'est pr√™t.</p>
    <a class="modal-btn" id="confirmTrackBtn" href="commande.html">Suivre ma commande</a>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer class="footer">A Beyrouth ‚Äî La D√©fense ‚Äî beyrouth.express</footer>

<!-- ===== SUPABASE ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ===== CONFIG =====
const SUPABASE_URL = 'https://xbuftfwcyontgqbbrrjt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhidWZ0ZndjeW9udGdxYmJycmp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2Njg1NzksImV4cCI6MjA4NjI0NDU3OX0.ROkSccADlpLsWMgqyiX_xNaFdJNR8P4R-LJCnZV2Gzg';
let sb = null;
try { sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null; } catch(e) { console.error('Supabase init error:', e); }

// ===== STATE =====
let categories = [];
let menuItems = [];
let ingredients = [];
let cart = JSON.parse(localStorage.getItem('be_cart') || '[]');

// ===== DEMO DATA (menu r√©el A Beyrouth) =====
const DEMO_CATEGORIES = [
  {id:1, nom:'Sandwichs', ordre:1, emoji:'üåØ'},
  {id:2, nom:'Formules', ordre:2, emoji:'üçΩÔ∏è'},
  {id:3, nom:'Grillades', ordre:3, emoji:'üî•'},
  {id:4, nom:'Plateaux', ordre:4, emoji:'ü•ò'},
  {id:5, nom:'Entr√©es', ordre:5, emoji:'üßÜ'},
  {id:6, nom:'Desserts', ordre:6, emoji:'üçÆ'},
  {id:7, nom:'Boissons', ordre:7, emoji:'ü•§'},
];

const DEMO_ITEMS = [
  // === SANDWICHS (tous √† 8.90‚Ç¨) ===
  {id:1, categorie_id:1, nom:'Shawarma Poulet', description:'√âminc√© de poulet marin√©, crudit√©s, sauce maison', prix:8.90, emoji:'üåØ', image_url:'img/sandwich-shawarma.jpg', disponible:true},
  {id:2, categorie_id:1, nom:'Chich Taouk', description:'Brochette de blanc de poulet marin√©', prix:8.90, emoji:'üåØ', disponible:true},
  {id:3, categorie_id:1, nom:'Shawarma Boeuf', description:'√âminc√© de boeuf marin√©, crudit√©s, sauce maison', prix:8.90, emoji:'üåØ', disponible:true},
  {id:4, categorie_id:1, nom:'Falafel', description:'Boulette de f√®ves et pois chiches', prix:8.90, emoji:'üßÜ', image_url:'img/sandwich-falafel.jpg', disponible:true},
  {id:5, categorie_id:1, nom:'Veggie', description:'Chou fleur, aubergine, crudit√©s', prix:8.90, emoji:'ü•¨', disponible:true},
  {id:6, categorie_id:1, nom:'Foie de Volaille', description:'Marin√© au citron', prix:8.90, emoji:'üçó', disponible:true},
  {id:7, categorie_id:1, nom:'Kafta', description:'Brochette de boeuf hach√©e persill√©e', prix:8.90, emoji:'üç¢', disponible:true},
  {id:8, categorie_id:1, nom:'Soujouk', description:'Saucisses de boeuf √©pic√©es', prix:8.90, emoji:'üå≠', disponible:true},

  // === FORMULES ===
  {id:10, categorie_id:2, nom:'Formule 1', description:'Sandwich + 2 feuillet√©s + boisson', prix:10.90, emoji:'1Ô∏è‚É£', disponible:true},
  {id:11, categorie_id:2, nom:'Formule 2', description:'Sandwich + entr√©e froide + boisson', prix:11.70, emoji:'2Ô∏è‚É£', disponible:true},
  {id:12, categorie_id:2, nom:'Formule 3', description:'Sandwich + dessert + boisson', prix:11.70, emoji:'3Ô∏è‚É£', disponible:true},
  {id:13, categorie_id:2, nom:'Formule 4', description:'2 sandwiches au choix + boisson', prix:14.90, emoji:'4Ô∏è‚É£', disponible:true},
  {id:14, categorie_id:2, nom:'Formule Plat du Jour', description:'Plat du jour + boisson', prix:13.50, emoji:'üçΩÔ∏è', image_url:'img/plat-jour.jpg', disponible:true},

  // === GRILLADES ===
  {id:20, categorie_id:3, nom:'Kafta M√©choui', description:'2 brochettes boeuf, riz, crudit√©s', prix:13.00, emoji:'üç¢', disponible:true},
  {id:21, categorie_id:3, nom:'Chich Taouk', description:'2 brochettes poulet, riz, crudit√©s', prix:13.00, emoji:'üçó', disponible:true},
  {id:22, categorie_id:3, nom:'Shawarma Poulet', description:'Poulet grill√© √† la broche, riz, crudit√©s', prix:14.00, emoji:'üåØ', disponible:true},
  {id:23, categorie_id:3, nom:'Shawarma Boeuf', description:'Boeuf grill√© √† la broche, riz, crudit√©s', prix:15.00, emoji:'üåØ', disponible:true},
  {id:24, categorie_id:3, nom:'Grillade Mixte', description:'Shawarma, kafta, chich taouk, riz', prix:15.00, emoji:'üî•', disponible:true},

  // === PLATEAUX ===
  {id:30, categorie_id:4, nom:'Beyrouth Poulet', description:'Houmous, moutabal, taboul√©, shawarma poulet, riz', prix:14.00, emoji:'ü•ò', disponible:true},
  {id:31, categorie_id:4, nom:'Beyrouth Boeuf', description:'Houmous, moutabal, taboul√©, shawarma boeuf, riz', prix:15.00, emoji:'ü•ò', disponible:true},
  {id:32, categorie_id:4, nom:'V√©g√©tarienne', description:'Houmous, moutabal, moussaka, 3 feuillet√©s', prix:14.00, emoji:'ü•¨', disponible:true},
  {id:33, categorie_id:4, nom:'Falafel', description:'Houmous, moutabal, taboul√©, 3 falafels', prix:14.00, emoji:'üßÜ', image_url:'img/falafel.jpg', disponible:true},
  {id:34, categorie_id:4, nom:'Liban', description:'Houmous, moutabal, chich taouk, riz, 2 feuillet√©s', prix:16.00, emoji:'üá±üáß', disponible:true},
  {id:35, categorie_id:4, nom:'Byblos', description:'Le plateau complet : houmous, taboul√©, kafta, chich taouk, shawarma, riz', prix:18.00, emoji:'üëë', disponible:true},

  // === ENTR√âES ===
  {id:40, categorie_id:5, nom:'Houmous', description:'Pois chiches, tahini, huile d\'olive', prix:4.50, emoji:'ü´ò', image_url:'img/houmous.jpg', disponible:true},
  {id:41, categorie_id:5, nom:'Moutabal', description:'Aubergine fum√©e, tahini, grenade', prix:4.50, emoji:'üçÜ', image_url:'img/moutabal.jpg', disponible:true},
  {id:42, categorie_id:5, nom:'Taboul√©', description:'Persil, boulgour, tomates, menthe', prix:4.50, emoji:'ü•ó', image_url:'img/taboule.jpg', disponible:true},

  // === DESSERTS ===
  {id:50, categorie_id:6, nom:'Mouhalabieh', description:'Flan fleur d\'oranger, pistaches (fait maison)', prix:4.00, emoji:'üçÆ', image_url:'img/mouhalabieh.jpg', disponible:true},
  {id:51, categorie_id:6, nom:'Namoura', description:'G√¢teau de semoule, sirop fleur d\'oranger', prix:4.00, emoji:'üç∞', image_url:'img/namoura.jpg', disponible:true},
  {id:52, categorie_id:6, nom:'Baklawas', description:'Bo√Æte de 3 pi√®ces', prix:4.50, emoji:'üçØ', disponible:true},
  {id:53, categorie_id:6, nom:'Duo Sabl√©s', description:'2 sabl√©s : pistaches, amandes, noix ou dattes', prix:5.00, emoji:'üç™', disponible:true},

  // === BOISSONS ===
  {id:60, categorie_id:7, nom:'Soft 33cl', description:'Coca, Sprite, Orangina...', prix:2.00, emoji:'ü•§', disponible:true},
  {id:61, categorie_id:7, nom:'Ayran', description:'Yaourt sal√©, rafra√Æchissant', prix:2.50, emoji:'ü•õ', disponible:true},
  {id:62, categorie_id:7, nom:'Eau Plate', description:'50cl', prix:2.00, emoji:'üíß', disponible:true},
];

// ===== INIT =====
document.addEventListener('DOMContentLoaded', init);

async function init() {
  generateTimeSlots();
  if (sb) {
    await loadFromSupabase();
    subscribeRealtime();
  } else {
    categories = DEMO_CATEGORIES;
    menuItems = DEMO_ITEMS;
  }
  renderMenu();
  renderNavCats();
  updateCartUI();
  setupScrollSpy();
  setTiming('now');
}

// ===== SUPABASE =====
async function loadFromSupabase() {
  try {
    const [catRes, itemRes, ingRes] = await Promise.all([
      sb.from('menu_categories').select('*').order('ordre'),
      sb.from('menu_items').select('*').eq('actif', true).order('id'),
      sb.from('ingredients').select('*'),
    ]);
    if (catRes.data && catRes.data.length && itemRes.data && itemRes.data.length) {
      categories = catRes.data;
      menuItems = itemRes.data;
      if (ingRes.data) ingredients = ingRes.data;
      applyIngredientAvailability();
    } else {
      throw new Error('Donn√©es incompl√®tes');
    }
  } catch (e) {
    console.error('Erreur chargement:', e);
    categories = DEMO_CATEGORIES;
    menuItems = DEMO_ITEMS;
  }
}

function applyIngredientAvailability() {
  const unavailable = new Set(ingredients.filter(i => !i.disponible).map(i => i.nom.toLowerCase()));
  menuItems.forEach(item => {
    if (item.ingredients && Array.isArray(item.ingredients)) {
      if (item.ingredients.some(ing => unavailable.has(ing.toLowerCase()))) item.disponible = false;
    }
  });
}

function subscribeRealtime() {
  sb.channel('menu-changes')
    .on('postgres_changes', {event:'*', schema:'public', table:'ingredients'}, () => loadFromSupabase().then(renderMenu))
    .on('postgres_changes', {event:'*', schema:'public', table:'menu_items'}, () => loadFromSupabase().then(renderMenu))
    .subscribe();
}

// ===== RENDER =====
function renderMenu() {
  const container = document.getElementById('menuContent');
  let html = '';
  categories.forEach(cat => {
    const items = menuItems.filter(i => i.categorie_id === cat.id);
    if (!items.length) return;
    html += `<h2 class="menu-cat-title" id="cat-${cat.id}">${cat.nom}</h2>`;
    html += '<div class="menu-list">';
    items.forEach(item => {
      const qty = getCartQty(item.id);
      html += `
        <div class="menu-item ${!item.disponible ? 'menu-item-unavailable' : ''}" data-id="${item.id}" onclick="${item.disponible ? `addToCart(${item.id})` : ''}">
          <div class="menu-item-info">
            <div class="menu-item-name">${item.nom}</div>
            <div class="menu-item-desc">${item.description || ''}</div>
          </div>
          <div class="menu-item-price">${formatPrice(item.prix)}</div>
          ${item.image_url
            ? `<div class="menu-item-img"><img src="${item.image_url}" alt="${item.nom}" loading="lazy"></div>`
            : `<div class="menu-item-img"><span>${item.emoji || 'üçΩÔ∏è'}</span></div>`
          }
          <button class="menu-item-add ${qty > 0 ? 'in-cart' : ''}"
                  onclick="event.stopPropagation();addToCart(${item.id})"
                  ${!item.disponible ? 'disabled' : ''}>
            ${qty > 0 ? qty : '+'}
          </button>
        </div>`;
    });
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderNavCats() {
  const nav = document.getElementById('navCats');
  nav.innerHTML = categories.map(cat =>
    `<button class="nav-cat" data-cat="${cat.id}" onclick="scrollToCat(${cat.id})">${cat.nom}</button>`
  ).join('');
}

// ===== CART =====
function getCartQty(id) { const c = cart.find(c => c.id === id); return c ? c.qty : 0; }

function addToCart(itemId) {
  const item = menuItems.find(i => i.id === itemId);
  if (!item || !item.disponible) return;
  const existing = cart.find(c => c.id === itemId);
  if (existing) { existing.qty++; } else {
    cart.push({id: item.id, nom: item.nom, prix: item.prix, emoji: item.emoji || 'üçΩÔ∏è', qty: 1});
  }
  saveCart(); updateCartUI(); renderMenu();
}

function changeQty(itemId, delta) {
  const item = cart.find(c => c.id === itemId);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) cart = cart.filter(c => c.id !== itemId);
  saveCart(); updateCartUI(); renderMenu();
}

function updateCartUI() {
  const total = cart.reduce((s, c) => s + c.prix * c.qty, 0);
  const count = cart.reduce((s, c) => s + c.qty, 0);

  // Bottom bar
  const bar = document.getElementById('bottomBar');
  bar.classList.toggle('show', count > 0);
  document.getElementById('bottomCount').textContent = count;
  document.getElementById('bottomTotal').textContent = formatPrice(total);

  // Cart panel
  const itemsEl = document.getElementById('cartItems');
  const emptyEl = document.getElementById('cartEmpty');
  const footerEl = document.getElementById('cartFooter');
  const totalEl = document.getElementById('cartTotal');

  if (cart.length === 0) {
    emptyEl.style.display = '';
    footerEl.style.display = 'none';
    itemsEl.querySelectorAll('.cart-item').forEach(el => el.remove());
    return;
  }
  emptyEl.style.display = 'none';
  footerEl.style.display = '';
  totalEl.textContent = formatPrice(total);

  const existing = itemsEl.querySelectorAll('.cart-item');
  existing.forEach(el => el.remove());
  cart.forEach(c => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `
      <div class="cart-item-emoji">${c.emoji}</div>
      <div class="cart-item-info">
        <div class="cart-item-name">${c.nom}</div>
        <div class="cart-item-price">${formatPrice(c.prix)} chacun</div>
      </div>
      <div class="cart-item-qty">
        <button onclick="changeQty(${c.id},-1)">&minus;</button>
        <span>${c.qty}</span>
        <button onclick="changeQty(${c.id},1)">+</button>
      </div>`;
    itemsEl.appendChild(div);
  });
}

function toggleCart() {
  document.getElementById('cartOverlay').classList.toggle('open');
  document.getElementById('cartPanel').classList.toggle('open');
  document.body.style.overflow = document.getElementById('cartPanel').classList.contains('open') ? 'hidden' : '';
}

function saveCart() { localStorage.setItem('be_cart', JSON.stringify(cart)); }

// ===== TIME SLOTS =====
function generateTimeSlots() {
  const sel = document.getElementById('pickupTime');
  const now = new Date();
  for (let m = 11*60; m <= 15*60; m += 15) {
    const h = Math.floor(m/60), min = m%60;
    const label = `${h}h${min.toString().padStart(2,'0')}`;
    const opt = document.createElement('option');
    opt.value = label; opt.textContent = label;
    const t = new Date(); t.setHours(h, min, 0);
    if (t <= now) opt.disabled = true;
    sel.appendChild(opt);
  }
}

// ===== ORDER =====
async function submitOrder() {
  const name = document.getElementById('clientName').value.trim();
  const email = document.getElementById('clientEmail').value.trim();
  const phone = document.getElementById('clientPhone').value.trim();
  const pickup = document.getElementById('pickupTime').value;

  if (!name) { alert('Entrez votre pr√©nom'); return; }
  if (!phone) { alert('Entrez votre t√©l√©phone'); return; }
  if (!email || !email.includes('@')) { alert('Entrez un email valide'); return; }
  if (timingMode === 'later' && !pickup) { alert('Choisissez une heure de retrait'); return; }
  if (!cart.length) return;

  const btn = document.getElementById('cartSubmit');
  btn.disabled = true; btn.textContent = 'Envoi...';

  const total = cart.reduce((s, c) => s + c.prix * c.qty, 0);
  const orderNum = 'BE-' + String(Math.floor(Math.random()*9000)+1000);

  const orderData = {
    numero: orderNum,
    items: cart.map(c => ({id:c.id, nom:c.nom, prix:c.prix, qty:c.qty})),
    total: Math.round(total*100)/100,
    statut: 'payee',
    heure_retrait: pickup,
    client_prenom: name, client_email: email,
    client_telephone: phone || null,
    created_at: new Date().toISOString(),
  };

  if (sb) {
    try {
      await sb.from('clients').upsert({
        email, prenom: name, telephone: phone || null,
        derniere_commande: new Date().toISOString(),
      }, {onConflict: 'email'});
      const {error} = await sb.from('orders').insert([orderData]).select();
      if (error) throw error;
      showConfirmation(orderNum);
    } catch (e) {
      console.error('Erreur:', e);
      alert('Erreur, r√©essayez.'); btn.disabled = false; btn.textContent = 'Passer la commande';
    }
  } else {
    setTimeout(() => showConfirmation(orderNum), 600);
  }
}

function showConfirmation(orderNum) {
  toggleCart();
  document.getElementById('confirmOrderNum').textContent = orderNum;
  document.getElementById('confirmTrackBtn').href = `commande.html?num=${orderNum}`;
  document.getElementById('confirmModal').classList.add('open');
  cart = []; saveCart(); updateCartUI(); renderMenu();
  document.getElementById('cartSubmit').disabled = false;
  document.getElementById('cartSubmit').textContent = 'Passer la commande';
  ['clientName','clientEmail','clientPhone','pickupTime'].forEach(id => document.getElementById(id).value = '');
}

// ===== NAV =====
function scrollToCat(catId) {
  const el = document.getElementById('cat-' + catId);
  if (el) {
    const navH = document.getElementById('nav').offsetHeight;
    window.scrollTo({top: el.offsetTop - navH - 8, behavior:'smooth'});
  }
  document.querySelectorAll('.nav-cat').forEach(b => b.classList.toggle('active', +b.dataset.cat === catId));
}

function setupScrollSpy() {
  const nav = document.getElementById('nav');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const id = e.target.id.replace('cat-','');
        document.querySelectorAll('.nav-cat').forEach(b => b.classList.toggle('active', b.dataset.cat === id));
        // Auto-scroll nav to active cat
        const active = document.querySelector('.nav-cat.active');
        if (active) active.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
      }
    });
  }, {rootMargin: `-${nav.offsetHeight + 20}px 0px -70% 0px`, threshold:0});
  categories.forEach(cat => {
    const el = document.getElementById('cat-' + cat.id);
    if (el) observer.observe(el);
  });
}

// ===== TIMING PICKER =====
let timingMode = 'now'; // 'now' ou 'later'
function setTiming(mode) {
  timingMode = mode;
  document.getElementById('btnNow').classList.toggle('active', mode === 'now');
  document.getElementById('btnLater').classList.toggle('active', mode === 'later');
  const sel = document.getElementById('pickupTime');
  if (mode === 'now') {
    sel.value = 'asap';
    sel.style.display = 'none';
  } else {
    sel.value = '';
    sel.style.display = '';
  }
}

// ===== UTILS =====
function formatPrice(n) { return n.toFixed(2).replace('.', ',') + ' ‚Ç¨'; }

document.getElementById('confirmModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('open');
});
</script>
</body>
</html>
